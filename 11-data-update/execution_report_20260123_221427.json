{
  "timestamp": "2026-01-23T22:14:27.026322",
  "directory": "11-data-update",
  "summary": {
    "total_files": 8,
    "total_statements": 376,
    "total_success": 352,
    "total_errors": 24
  },
  "results": {
    "11-data-update\\01_mutation_update_examples.sql": [
      {
        "statement": "-- ================================================\n-- 01_mutation_update_examples.sql\n-- 从 01_mutation_update.md 提取的 SQL 示例\n-- 提取时间: 2026-01-23 14:40:17\n-- ===========================================",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 更新单个字段\n-- ========================================\n\nALTER TABLE table_name\nUPDATE \n    column1 = value1,\n    column2 = value2,\n    column3 = value3\nWHERE",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 更新单个字段\n-- ========================================\n\nALTER TABLE users\nUPDATE \n    age = age + 1,\n    last_updated = now()\nWHERE status = 'active'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 更新单个字段\n-- ========================================\n\n-- 准备测试表\nCREATE TABLE test_mutations.users (\n    user_id UInt64,\n    username String,\n    email Strin",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 插入测试数据\nINSERT INTO test_mutations.users (user_id, username, email, status, created_at, last_login) VALUES\n(1, 'user1', 'user1@example.com', 'pending', '2024-01-15 08:00:00', '2024-01-15 08:00:00'),",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 更新用户状态\nALTER TABLE test_mutations.users\nUPDATE status = 'active'\nWHERE user_id IN (1, 2, 4, 5)",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 验证更新结果\nSELECT user_id, username, status FROM test_mutations.users",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 更新单个字段\n-- ========================================\n\n-- 更新订单金额（10% 涨价）\nALTER TABLE test_mutations.orders\nUPDATE amount = amount * 1.1\nWHERE order_date >= ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 更新单个字段\n-- ========================================\n\n-- 更新用户等级\nALTER TABLE test_mutations.users\nUPDATE level = CASE\n    WHEN total_spent >= 10000 THEN 'go",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 更新单个字段\n-- ========================================\n\n-- 更新用户的最后登录时间\nALTER TABLE test_mutations.users\nUPDATE last_login = (\n    SELECT max(event_time)\n    ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 更新单个字段\n-- ========================================\n\n-- 分批更新以减少性能影响\nALTER TABLE test_mutations.large_table\nUPDATE status = 'processed'\nWHERE event_time >=",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 0: 异步, 1: 等待当前分片, 2: 等待所有分片\n\n-- ========================================\n-- 更新单个字段\n-- ========================================\n\nSELECT \n    database,\n    table,\n    mutation_id,\n    command,\n    is",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 更新单个字段\n-- ========================================\n\n-- 查看特定 Mutation 的详细信息\nSELECT \n    mutation_id,\n    command,\n    is_done,\n    parts_to_do,\n    parts_",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 更新单个字段\n-- ========================================\n\n-- 实时监控所有正在进行的 Mutation\nSELECT \n    database,\n    table,\n    mutation_id,\n    command,\n    is_done,\n ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 更新单个字段\n-- ========================================\n\n-- 查看最近完成的 Mutation\nSELECT \n    database,\n    table,\n    mutation_id,\n    command,\n    is_done,\n    p",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 更新单个字段\n-- ========================================\n\n-- 异步执行（默认）\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id = 123\nSETTINGS mutations_sync = ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 等待当前分片完成\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id = 123\nSETTINGS mutations_sync = 1",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 等待所有分片完成\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id = 123\nSETTINGS mutations_sync = 2",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 更新单个字段\n-- ========================================\n\n-- 限制并发线程数\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id IN (1, 2, 3)\nSETTINGS max_threads",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 限制内存使用\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id IN (1, 2, 3)\nSETTINGS max_memory_usage = 10000000000",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 10GB\n\n-- ========================================\n-- 更新单个字段\n-- ========================================\n\n-- 设置 Mutation 优先级（1-10，默认 5）\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id = 123",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 更新单个字段\n-- ========================================\n\n-- 使用字符串函数\nALTER TABLE users\nUPDATE email = lower(email)\nWHERE status = 'active'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 使用日期函数\nALTER TABLE users\nUPDATE last_login = toDateTime(toStartOfDay(last_login))\nWHERE last_login >= now() - INTERVAL 30 DAY",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 使用数学函数\nALTER TABLE orders\nUPDATE amount = round(amount * 1.1, 2)\nWHERE order_date >= '2024-01-01'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 更新单个字段\n-- ========================================\n\n-- 使用 CASE WHEN\nALTER TABLE users\nUPDATE status = CASE\n    WHEN last_login < now() - INTERVAL 90 DAY ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 使用多条件\nALTER TABLE users\nUPDATE level = 'premium'\nWHERE total_spent > 10000\n  AND registration_date > '2023-01-01'\n  AND status = 'active'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 更新单个字段\n-- ========================================\n\n-- 使用 JOIN 更新\nALTER TABLE users\nUPDATE orders_count = (\n    SELECT count()\n    FROM orders\n    WHERE ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 更新单个字段\n-- ========================================\n\n-- 使用合理的分区键\nCREATE TABLE users (\n    user_id UInt64,\n    created_at DateTime,\n    -- 其他字段\n) ENGINE = ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 更新单个字段\n-- ========================================\n\n-- 只更新特定分区\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id IN (1, 2, 3)\n  AND created_at >= ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 更新单个字段\n-- ========================================\n\n-- 使用主键\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id = 123",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 快速\n\n-- 避免低选择性条件\nALTER TABLE users\nUPDATE status = 'active'\nWHERE email LIKE '%@example.com'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 慢速\n\n-- ========================================\n-- 更新单个字段\n-- ========================================\n\n-- 将大更新拆分为小批次\n-- 批次 1\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id BETWEEN 1 AND 1",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 批次 2\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id BETWEEN 1001 AND 2000",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 继续分批...\n\n-- ========================================\n-- 更新单个字段\n-- ========================================\n\n-- 检查 Mutation 状态\nSELECT * FROM system.mutations\nWHERE is_done = 0",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 检查是否有锁\nSELECT * FROM system.replication_queue\nWHERE type = 'Mutation'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 检查错误信息\nSELECT exception_text FROM system.mutations\nWHERE is_done = 0",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 更新单个字段\n-- ========================================\n\n-- 查看失败原因\nSELECT \n    mutation_id,\n    command,\n    latest_failed_part,\n    latest_fail_reason,\n    l",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 修复后重新执行 Mutation\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id IN (1, 2, 3)",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 更新单个字段\n-- ========================================\n\n-- 1. 检查分区大小\nSELECT \n    partition,\n    sum(rows) as rows,\n    formatReadableSize(sum(bytes_on_disk))",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 2. 使用更具体的 WHERE 条件\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id IN (1, 2, 3)\n  AND created_at >= '2024-01-01'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 3. 分批处理\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id IN (1, 2, 3)\nSETTINGS max_threads = 2",
        "success": true,
        "result": "Comment - skipped"
      }
    ],
    "11-data-update\\02_lightweight_update_examples.sql": [
      {
        "statement": "-- ================================================\n-- 02_lightweight_update_examples.sql\n-- 从 02_lightweight_update.md 提取的 SQL 示例\n-- 提取时间: 2026-01-23 14:40:17\n-- =====================================",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 启用轻量级更新\n-- ========================================\n\n-- 设置全局配置（需要重启）\n-- 在 config.xml 中添加：\n<lightweight_update>1</lightweight_update>\n\n-- ================",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 启用轻量级更新\n-- ========================================\n\n-- 准备测试表\nCREATE TABLE test_lightweight.users (\n    user_id UInt64,\n    username String,\n    email St",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 插入测试数据\nINSERT INTO test_lightweight.users (user_id, username, email, status, created_at, last_login) VALUES\n(1, 'user1', 'user1@example.com', 'pending', '2024-01-15 08:00:00', '2024-01-15 08:00:00'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 使用轻量级更新\nALTER TABLE test_lightweight.users\nUPDATE status = 'active'\nWHERE user_id IN (1, 2, 4, 5)\nSETTINGS lightweight_update = 1",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 验证更新结果\nSELECT user_id, username, status FROM test_lightweight.users",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 启用轻量级更新\n-- ========================================\n\n-- 批量更新用户状态\nALTER TABLE test_lightweight.users\nUPDATE status = 'inactive'\nWHERE last_login < now() -",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 批量更新用户等级\nALTER TABLE test_lightweight.users\nUPDATE level = CASE\n    WHEN total_spent >= 10000 THEN 'gold'\n    WHEN total_spent >= 5000 THEN 'silver'\n    WHEN total_spent >= 1000 THEN 'bronze'\n    E",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 启用轻量级更新\n-- ========================================\n\n-- 使用字符串函数\nALTER TABLE test_lightweight.users\nUPDATE email = lower(trim(email))\nWHERE email != lower",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 使用日期函数\nALTER TABLE test_lightweight.users\nUPDATE last_login = toDateTime(toStartOfDay(last_login))\nWHERE last_login >= now() - INTERVAL 30 DAY\nSETTINGS lightweight_update = 1",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 使用数学函数\nALTER TABLE test_lightweight.orders\nUPDATE amount = round(amount * 1.1, 2)\nWHERE order_date >= '2024-01-01'\n  AND status = 'pending'\nSETTINGS lightweight_update = 1",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 启用轻量级更新\n-- ========================================\n\n-- 同时更新多个字段\nALTER TABLE test_lightweight.users\nUPDATE \n    status = 'active',\n    last_login = now()",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 启用轻量级更新\n-- ========================================\n\n-- 使用复杂条件\nALTER TABLE test_lightweight.users\nUPDATE premium_status = CASE\n    WHEN total_spent > 100",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 启用轻量级更新\n-- ========================================\n\n-- 创建测试表\nCREATE TABLE test_lightweight.compare_table (\n    id UInt64,\n    value String,\n    status S",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 插入 100 万条测试数据\nINSERT INTO test_lightweight.compare_table\nSELECT \n    number as id,\n    toString(number) as value,\n    'pending' as status,\n    now() - INTERVAL (rand() % 365) DAY as created_at\nFROM",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 测试 1: 传统 Mutation\n-- 记录开始时间\nSELECT now() as start_time",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "ALTER TABLE test_lightweight.compare_table\nUPDATE status = 'active'\nWHERE id % 10 = 0",
        "success": false,
        "result": "HTTP 404: Code: 60. DB::Exception: Could not find table: compare_table. (UNKNOWN_TABLE) (version 25.12.3.21 (official build))\n"
      },
      {
        "statement": "-- 记录结束时间\nSELECT now() as end_time",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 测试 2: 轻量级更新\n-- 记录开始时间\nSELECT now() as start_time",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "ALTER TABLE test_lightweight.compare_table\nUPDATE status = 'processed'\nWHERE id % 10 = 1\nSETTINGS lightweight_update = 1",
        "success": false,
        "result": "HTTP 404: Code: 115. DB::Exception: Setting lightweight_update is neither a builtin setting nor started with the prefix 'SQL_' registered for user-defined settings. (UNKNOWN_SETTING) (version 25.12.3.21 (offici"
      },
      {
        "statement": "-- 记录结束时间\nSELECT now() as end_time",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 启用轻量级更新\n-- ========================================\n\n-- 查看 Mutation 列表（包含轻量级更新）\nSELECT \n    database,\n    table,\n    mutation_id,\n    command,\n    is_don",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 查看轻量级更新统计\nSELECT \n    database,\n    table,\n    sum(rows) as total_rows,\n    formatReadableSize(sum(bytes_on_disk)) as total_size,\n    count() as mutation_count\nFROM system.mutations\nWHERE database ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 启用轻量级更新\n-- ========================================\n\n-- 查看特定 Mutation 的状态\nSELECT \n    mutation_id,\n    command,\n    is_done,\n    parts_to_do,\n    parts_t",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 启用轻量级更新\n-- ========================================\n\n-- 强制合并以应用轻量级更新\nOPTIMIZE TABLE test_lightweight.users\nFINAL\nSETTINGS mutations_sync = 1",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 启用轻量级更新\n-- ========================================\n\n-- 创建表时指定设置\nCREATE TABLE users (\n    user_id UInt64,\n    username String,\n    status String\n) ENGINE",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 启用轻量级更新\n-- ========================================\n\n-- 启用轻量级更新\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id = 123\nSETTINGS lightweight_updat",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 禁用轻量级更新（使用传统 Mutation）\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id = 123\nSETTINGS lightweight_update = 0",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 启用轻量级更新\n-- ========================================\n\n-- 更新用户的订单数量\nALTER TABLE test_lightweight.users\nUPDATE orders_count = (\n    SELECT count()\n    FROM ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 启用轻量级更新\n-- ========================================\n\n-- 关联更新\nALTER TABLE test_lightweight.users\nUPDATE last_order_amount = (\n    SELECT max(amount)\n    F",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 启用轻量级更新\n-- ========================================\n\n-- 使用复杂表达式更新\nALTER TABLE test_lightweight.users\nUPDATE score = (\n    0.3 * login_score +\n    0.4 * p",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 启用轻量级更新\n-- ========================================\n\n-- 分批执行轻量级更新\n-- 批次 1: 更新 ID 1-1000\nALTER TABLE test_lightweight.users\nUPDATE status = 'active'\nWHERE",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 批次 2: 更新 ID 1001-2000\nALTER TABLE test_lightweight.users\nUPDATE status = 'active'\nWHERE user_id BETWEEN 1001 AND 2000\nSETTINGS lightweight_update = 1",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 继续分批...\n\n-- ========================================\n-- 启用轻量级更新\n-- ========================================\n\n-- 使用合适的分区键\nCREATE TABLE users (\n    user_id UInt64,\n    created_at DateTime,\n    -- 其他字",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 启用轻量级更新\n-- ========================================\n\n-- 只更新特定分区\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id IN (1, 2, 3)\n  AND created_at >=",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 启用轻量级更新\n-- ========================================\n\n-- 使用主键\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id IN (1, 2, 3)  -- 快速\nSETTINGS lightw",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 避免低选择性条件\nALTER TABLE users\nUPDATE status = 'active'\nWHERE status = 'pending'  -- 慢速\nSETTINGS lightweight_update = 1",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 启用轻量级更新\n-- ========================================\n\n-- 限制并发线程数\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id IN (1, 2, 3)\nSETTINGS \n    light",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 启用轻量级更新\n-- ========================================\n\n-- 强制合并\nOPTIMIZE TABLE users\nFINAL\nSETTINGS mutations_sync = 1",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 或等待后台合并完成\n\n-- ========================================\n-- 启用轻量级更新\n-- ========================================\n\n-- 1. 检查配置\nSELECT \n    name,\n    value,\n    changed\nFROM system.settings\nWHERE name LI",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 2. 使用更具体的 WHERE 条件\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id IN (1, 2, 3)\n  AND created_at >= '2024-01-01'\nSETTINGS lightweight_update = 1",
        "success": true,
        "result": "Comment - skipped"
      }
    ],
    "11-data-update\\03_partition_update_examples.sql": [
      {
        "statement": "-- ================================================\n-- 03_partition_update_examples.sql\n-- 从 03_partition_update.md 提取的 SQL 示例\n-- 提取时间: 2026-01-23 14:40:17\n-- =========================================",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 替换多个分区\nALTER TABLE table_name\nREPLACE PARTITION partition_expr1, partition_expr2, ...\nFROM source_table",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- REPLACE PARTITION\n-- ========================================\n\n-- 交换分区\nALTER TABLE table1\nEXCHANGE PARTITIONS partition_expr\nWITH table2",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 交换特定分区\nALTER TABLE table1\nEXCHANGE PARTITION '202401'\nWITH table2",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- REPLACE PARTITION\n-- ========================================\n\n-- 删除分区\nALTER TABLE table_name\nDROP PARTITION partition_expr",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 重新插入数据\nINSERT INTO table_name\nSELECT * FROM source_table\nWHERE partition_condition",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- REPLACE PARTITION\n-- ========================================\n\n-- 准备测试表\nCREATE TABLE test_partition.users (\n    user_id UInt64,\n    username String,\n    ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 插入原始数据\nINSERT INTO test_partition.users VALUES\n(1, 'user1', 'user1@example.com', 'pending', '2024-01-15 08:00:00', '2024-01-15 08:00:00'),\n(2, 'user2', 'user2@example.com', 'pending', '2024-01-15 0",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 创建临时表\nCREATE TABLE test_partition.users_temp AS test_partition.users",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 更新数据（将 status 改为 active）\nINSERT INTO test_partition.users_temp\nSELECT \n    user_id,\n    username,\n    email,\n    'active' as status,\n    created_at,\n    now() as updated_at\nFROM test_partition.user",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 替换分区\nALTER TABLE test_partition.users\nREPLACE PARTITION '202401'\nFROM test_partition.users_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 验证结果\nSELECT user_id, username, status, updated_at \nFROM test_partition.users\nWHERE toYYYYMM(created_at) = '202401'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 清理临时表\nDROP TABLE test_partition.users_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- REPLACE PARTITION\n-- ========================================\n\n-- 创建两个表\nCREATE TABLE test_partition.table1 (\n    id UInt64,\n    value String,\n    created",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "CREATE TABLE test_partition.table2 (\n    id UInt64,\n    value String,\n    created_at DateTime\n) ENGINE = MergeTree()\nPARTITION BY toYYYYMM(created_at)\nORDER BY id",
        "success": false,
        "result": "HTTP 500: Code: 57. DB::Exception: Table test_partition.table2 already exists. (TABLE_ALREADY_EXISTS) (version 25.12.3.21 (official build))\n"
      },
      {
        "statement": "-- 向 table1 插入数据\nINSERT INTO test_partition.table1 VALUES\n(1, 'value1', '2024-01-15 08:00:00'),\n(2, 'value2', '2024-01-16 09:00:00'),\n(3, 'value3', '2024-02-01 10:00:00')",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 向 table2 插入数据\nINSERT INTO test_partition.table2 VALUES\n(11, 'value11', '2024-01-15 08:00:00'),\n(12, 'value12', '2024-01-16 09:00:00'),\n(13, 'value13', '2024-02-01 10:00:00')",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 交换分区（交换 2024-01 分区）\nALTER TABLE test_partition.table1\nEXCHANGE PARTITION '202401'\nWITH test_partition.table2",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 验证交换结果\nSELECT * FROM test_partition.table1 WHERE toYYYYMM(created_at) = '202401'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "SELECT * FROM test_partition.table2 WHERE toYYYYMM(created_at) = '202401'",
        "success": true,
        "result": "11\tvalue11\t2024-01-15 08:00:00\n12\tvalue12\t2024-01-16 09:00:00"
      },
      {
        "statement": "-- ========================================\n-- REPLACE PARTITION\n-- ========================================\n\n-- 备份分区数据\nCREATE TABLE test_partition.users_backup AS test_partition.users",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 删除旧分区\nALTER TABLE test_partition.users\nDROP PARTITION '202401'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 插入更新后的数据\nINSERT INTO test_partition.users\nSELECT \n    user_id,\n    username,\n    email,\n    'active' as status,\n    created_at,\n    now() as updated_at\nFROM test_partition.users_backup\nWHERE toYYYY",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 验证结果\nSELECT user_id, username, status, updated_at \nFROM test_partition.users\nWHERE toYYYYMM(created_at) = '202401'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 清理备份\nDROP TABLE test_partition.users_backup",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- REPLACE PARTITION\n-- ========================================\n\n-- 创建临时表\nCREATE TABLE test_partition.users_temp AS test_partition.users",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 更新多个分区的数据\nINSERT INTO test_partition.users_temp\nSELECT \n    user_id,\n    username,\n    email,\n    'inactive' as status,\n    created_at,\n    now() as updated_at\nFROM test_partition.users\nWHERE toYYY",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 替换多个分区\nALTER TABLE test_partition.users\nREPLACE PARTITION '202311', '202312', '202401'\nFROM test_partition.users_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 验证结果\nSELECT \n    toYYYYMM(created_at) as month,\n    count() as count,\n    countIf(status = 'inactive') as inactive_count\nFROM test_partition.users\nGROUP BY month",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- REPLACE PARTITION\n-- ========================================\n\n-- 创建源表和目标表\nCREATE TABLE test_partition.source_table (\n    id UInt64,\n    value String,\n  ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "CREATE TABLE test_partition.target_table (\n    id UInt64,\n    value String,\n    created_at DateTime\n) ENGINE = MergeTree()\nPARTITION BY toYYYYMM(created_at)\nORDER BY id",
        "success": false,
        "result": "HTTP 500: Code: 57. DB::Exception: Table test_partition.target_table already exists. (TABLE_ALREADY_EXISTS) (version 25.12.3.21 (official build))\n"
      },
      {
        "statement": "-- 向源表插入数据\nINSERT INTO test_partition.source_table VALUES\n(1, 'value1', '2024-01-15 08:00:00'),\n(2, 'value2', '2024-01-16 09:00:00'),\n(3, 'value3', '2024-02-01 10:00:00')",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 分离分区\nALTER TABLE test_partition.source_table\nDETACH PARTITION '202401'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 附加分区到目标表\nALTER TABLE test_partition.target_table\nATTACH PARTITION '202401'\nFROM test_partition.source_table",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 验证结果\nSELECT * FROM test_partition.target_table",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- REPLACE PARTITION\n-- ========================================\n\n-- 创建归档表\nCREATE TABLE test_partition.users_archive (\n    user_id UInt64,\n    username Stri",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 归档旧数据（2023 年的数据）\nALTER TABLE test_partition.users_archive\nREPLACE PARTITION '202301', '202302', '202303', \n                 '202304', '202305', '202306',\n                 '202307', '202308', '20230",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 验证归档\nSELECT \n    toYYYYMM(created_at) as month,\n    count() as count\nFROM test_partition.users_archive\nGROUP BY month\nORDER BY month",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- REPLACE PARTITION\n-- ========================================\n\n-- 创建新表（优化结构）\nCREATE TABLE test_partition.users_new (\n    user_id UInt64,\n    username Str",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 逐月迁移数据\nALTER TABLE test_partition.users_new\nREPLACE PARTITION '202401'\nFROM test_partition.users",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "ALTER TABLE test_partition.users_new\nREPLACE PARTITION '202402'\nFROM test_partition.users",
        "success": false,
        "result": "HTTP 404: Code: 60. DB::Exception: Could not find table: users_new. (UNKNOWN_TABLE) (version 25.12.3.21 (official build))\n"
      },
      {
        "statement": "-- 继续迁移其他月份...\n\n-- ========================================\n-- REPLACE PARTITION\n-- ========================================\n\n-- 创建修正后的数据\nCREATE TABLE test_partition.orders_fixed AS test_partition.ord",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 修正数据（将所有订单金额增加 10%）\nINSERT INTO test_partition.orders_fixed\nSELECT \n    order_id,\n    user_id,\n    product_id,\n    amount * 1.1 as amount,\n    order_date,\n    status\nFROM test_partition.orders\nWHER",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 替换分区\nALTER TABLE test_partition.orders\nREPLACE PARTITION '202401'\nFROM test_partition.orders_fixed",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 验证修正结果\nSELECT \n    order_id,\n    amount,\n    status\nFROM test_partition.orders\nWHERE toYYYYMM(order_date) = '202401'\n  AND status = 'pending'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- REPLACE PARTITION\n-- ========================================\n\n-- 创建临时表\nCREATE TABLE test_partition.events_temp AS test_partition.events",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 更新最近 3 个月的数据\nINSERT INTO test_partition.events_temp\nSELECT \n    event_id,\n    user_id,\n    event_type,\n    event_data,\n    processed = 1,\n    processed_at = now()\nFROM test_partition.events\nWHERE t",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 替换分区\nALTER TABLE test_partition.events\nREPLACE PARTITION \n    toYYYYMM(now() - INTERVAL 1 MONTH),\n    toYYYYMM(now() - INTERVAL 2 MONTH),\n    toYYYYMM(now() - INTERVAL 3 MONTH)\nFROM test_partition.",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 验证结果\nSELECT \n    toYYYYMM(event_time) as month,\n    count() as total,\n    countIf(processed = 1) as processed,\n    countIf(processed = 0) as unprocessed\nFROM test_partition.events\nGROUP BY month",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- REPLACE PARTITION\n-- ========================================\n\n-- 创建测试表\nCREATE TABLE test_partition.users_test AS test_partition.users",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 在测试表上测试更新逻辑\nINSERT INTO test_partition.users_test\nSELECT \n    user_id,\n    username,\n    email,\n    'active' as status,\n    created_at,\n    now() as updated_at\nFROM test_partition.users\nWHERE toYYY",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 验证测试结果\nSELECT count() FROM test_partition.users_test WHERE status = 'active'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 如果测试通过，交换分区到生产表\nALTER TABLE test_partition.users\nEXCHANGE PARTITION '202401'\nWITH test_partition.users_test",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 清理测试表\nDROP TABLE test_partition.users_test",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- REPLACE PARTITION\n-- ========================================\n\n-- 按月分区（推荐）\nCREATE TABLE events (\n    event_id UInt64,\n    user_id UInt64,\n    event_time ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 避免过于细粒度的分区\nPARTITION BY toYYYYMMDD(event_time)  -- 太多分区，影响性能\n\n-- ========================================\n-- REPLACE PARTITION\n-- ========================================\n\n-- 一次性替换多个分区（高效）\nALTER TA",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 避免逐个替换（低效）\nALTER TABLE users REPLACE PARTITION '202401' FROM users_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "ALTER TABLE users REPLACE PARTITION '202402' FROM users_temp",
        "success": false,
        "result": "HTTP 404: Code: 60. DB::Exception: Could not find table: users. (UNKNOWN_TABLE) (version 25.12.3.21 (official build))\n"
      },
      {
        "statement": "ALTER TABLE users REPLACE PARTITION '202403' FROM users_temp",
        "success": false,
        "result": "HTTP 404: Code: 60. DB::Exception: Could not find table: users. (UNKNOWN_TABLE) (version 25.12.3.21 (official build))\n"
      },
      {
        "statement": "-- ========================================\n-- REPLACE PARTITION\n-- ========================================\n\n-- 使用 EXCHANGE（快速）\nALTER TABLE table1\nEXCHANGE PARTITION '202401'\nWITH table2",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 替代 DROP + INSERT（慢速）\nALTER TABLE table1 DROP PARTITION '202401'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "INSERT INTO table1 SELECT * FROM table2 WHERE ...",
        "success": false,
        "result": "HTTP 400: Code: 62. DB::Exception: Syntax error: failed at position 47 (.): ...\n. Expected one of: expression with optional alias, element of expression with optional alias, lambda expression, CAST operator, NO"
      },
      {
        "statement": "-- ========================================\n-- REPLACE PARTITION\n-- ========================================\n\n-- 使用临时表存储更新后的数据\nCREATE TABLE temp_users AS users",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 更新数据\nINSERT INTO temp_users\nSELECT * FROM users WHERE ...",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 替换分区\nALTER TABLE users\nREPLACE PARTITION '202401'\nFROM temp_users",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 清理临时表\nDROP TABLE temp_users",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- REPLACE PARTITION\n-- ========================================\n\n-- 查看表的分区\nSELECT \n    partition,\n    sum(rows) as total_rows,\n    sum(bytes_on_disk) as to",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- REPLACE PARTITION\n-- ========================================\n\n-- 更新前后对比\n-- 更新前\nSELECT \n    toYYYYMM(created_at) as month,\n    status,\n    count() as cou",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 更新后\nSELECT \n    toYYYYMM(created_at) as month,\n    status,\n    count() as count\nFROM users\nWHERE toYYYYMM(created_at) = '202401'\nGROUP BY month, status",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- REPLACE PARTITION\n-- ========================================\n\n-- 查看最近的分区操作\nSELECT \n    type,\n    partition_id,\n    partition,\n    part_name,\n    rows,\n ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- REPLACE PARTITION\n-- ========================================\n\n-- 检查分区是否存在\nSELECT distinct partition\nFROM system.parts\nWHERE database = 'test_partition' ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 使用正确的分区名称\n\n-- ========================================\n-- REPLACE PARTITION\n-- ========================================\n\n-- 确保两个表的结构完全一致\nDESCRIBE TABLE test_partition.users",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "DESCRIBE TABLE test_partition.users_temp",
        "success": false,
        "result": "HTTP 404: Code: 60. DB::Exception: Table test_partition.users_temp does not exist. Maybe you meant migration_test.users_new?. (UNKNOWN_TABLE) (version 25.12.3.21 (official build))\n"
      },
      {
        "statement": "-- 如果结构不同，需要先修改表结构\nALTER TABLE test_partition.users_temp\nMODIFY COLUMN new_column String",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- REPLACE PARTITION\n-- ========================================\n\n-- 确保两个表的引擎相同\nSELECT engine FROM system.tables\nWHERE database = 'test_partition'\n  AND tab",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 如果引擎不同，需要先修改表引擎\nALTER TABLE test_partition.users_temp\nMODIFY ENGINE = MergeTree()",
        "success": true,
        "result": "Comment - skipped"
      }
    ],
    "11-data-update\\04_update_strategies_examples.sql": [
      {
        "statement": "-- ================================================\n-- 04_update_strategies_examples.sql\n-- 从 04_update_strategies.md 提取的 SQL 示例\n-- 提取时间: 2026-01-23 14:40:17\n-- =======================================",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 更新数据\nINSERT INTO logs_temp\nSELECT \n    event_id,\n    user_id,\n    event_type,\n    'processed' as status,\n    event_time\nFROM logs\nWHERE event_time >= '2024-01-01'\n  AND event_time < '2024-02-01'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 替换分区\nALTER TABLE logs\nREPLACE PARTITION '202401'\nFROM logs_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 清理\nDROP TABLE logs_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- SQL Block 2\n-- ========================================\n\n-- 轻量级更新（ClickHouse 23.8+）\nALTER TABLE users\nUPDATE status = 'active',\n    last_updated = now()\n",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 或使用 Mutation\nALTER TABLE users\nUPDATE status = 'active',\n    last_updated = now()\nWHERE user_id IN (1, 2, 3, 4, 5)",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- SQL Block 3\n-- ========================================\n\n-- 创建修正表\nCREATE TABLE orders_fixed AS orders",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 修正数据（所有金额增加 10%）\nINSERT INTO orders_fixed\nSELECT \n    order_id,\n    user_id,\n    product_id,\n    amount * 1.1 as amount,\n    order_date,\n    status\nFROM orders\nWHERE toYYYYMM(order_date) IN ('20240",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 替换分区\nALTER TABLE orders\nREPLACE PARTITION '202401', '202402', '202403'\nFROM orders_fixed",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 清理\nDROP TABLE orders_fixed",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- SQL Block 4\n-- ========================================\n\n-- 方案 1: 轻量级更新\nALTER TABLE orders\nUPDATE status = 'completed',\n    completed_at = now()\nWHERE or",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 方案 2: 重新设计表结构（追加模式）\n-- 原表: orders\n-- 新表: order_events (事件日志)\n-- 查询时取最新事件\n\n-- ========================================\n-- SQL Block 5\n-- ========================================\n\n-- 创建归档表\nCREATE TAB",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 交换分区\nALTER TABLE orders_archive\nEXCHANGE PARTITION '202301'\nWITH orders",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 继续交换其他月份...\n\n-- ========================================\n-- SQL Block 6\n-- ========================================\n\n-- 1. 最新数据使用轻量级更新\nALTER TABLE events\nUPDATE status = 'processed'\nWHERE event_tim",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 2. 旧数据使用分区更新归档\nALTER TABLE events_archive\nEXCHANGE PARTITION '202312'\nWITH events",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- SQL Block 7\n-- ========================================\n\n-- 创建物化视图\nCREATE MATERIALIZED VIEW user_stats_mv\nENGINE = SummingMergeTree()\nORDER BY (user_id, ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 使用 Mutation 更新原表\nALTER TABLE events\nUPDATE status = 'processed'\nWHERE event_time >= now() - INTERVAL 30 DAY",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- SQL Block 8\n-- ========================================\n\n-- 1. 使用分区更新\nALTER TABLE users\nREPLACE PARTITION '202401'\nFROM users_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 2. 定期合并\nOPTIMIZE TABLE users\nPARTITION '202401'\nFINAL",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- SQL Block 9\n-- ========================================\n\n-- 合理的分区策略\nCREATE TABLE events (\n    event_id UInt64,\n    user_id UInt64,\n    event_time DateTim",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- SQL Block 10\n-- ========================================\n\n-- 1. 备份数据\nCREATE TABLE users_backup AS users",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 2. 检查更新范围\nSELECT \n    count() as total_rows,\n    formatReadableSize(sum(bytes_on_disk)) as total_size\nFROM system.parts\nWHERE table = 'users'\n  AND partition IN ('202401', '202402')",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 3. 在测试环境验证\n-- 先在测试表上执行更新\n\n-- ========================================\n-- SQL Block 11\n-- ========================================\n\n-- 监控 Mutation 进度\nSELECT \n    mutation_id,\n    command,\n    is_don",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- SQL Block 12\n-- ========================================\n\n-- 验证更新结果\nSELECT \n    status,\n    count() as count\nFROM users\nWHERE toYYYYMM(created_at) = '202",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- SQL Block 13\n-- ========================================\n\n-- 错误做法\nALTER TABLE users UPDATE status = 'active'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 正确做法\nCREATE TABLE users_temp AS users",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "INSERT INTO users_temp SELECT * FROM users WHERE ...",
        "success": false,
        "result": "HTTP 400: Code: 62. DB::Exception: Syntax error: failed at position 50 (.): ...\n. Expected one of: expression with optional alias, element of expression with optional alias, lambda expression, CAST operator, NO"
      },
      {
        "statement": "ALTER TABLE users REPLACE PARTITION '202401' FROM users_temp",
        "success": false,
        "result": "HTTP 404: Code: 60. DB::Exception: Could not find table: users. (UNKNOWN_TABLE) (version 25.12.3.21 (official build))\n"
      },
      {
        "statement": "-- ========================================\n-- SQL Block 14\n-- ========================================\n\n-- 错误做法\n-- 每分钟执行一次\nALTER TABLE orders UPDATE status = 'new' WHERE order_id = x",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 正确做法\n-- 使用事件日志表\nCREATE TABLE order_events (\n    order_id UInt64,\n    event_type String,\n    event_time DateTime,\n    event_data String\n) ENGINE = MergeTree()\nORDER BY (order_id, event_time)",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 查询时取最新事件\n\n-- ========================================\n-- SQL Block 15\n-- ========================================\n\n-- 1. 先验证数据\nSELECT count() FROM users_temp WHERE status = 'active'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 2. 对比数据\nSELECT status, count() FROM users WHERE ... GROUP BY status",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "SELECT status, count() FROM users_temp WHERE ... GROUP BY status",
        "success": false,
        "result": "HTTP 400: Code: 62. DB::Exception: Syntax error: failed at position 46 (.): ... GROUP BY status\n. Expected one of: expression with optional alias, element of expression with optional alias, lambda expression, C"
      },
      {
        "statement": "-- 3. 确认无误后再替换\nALTER TABLE users REPLACE PARTITION '202401' FROM users_temp",
        "success": true,
        "result": "Comment - skipped"
      }
    ],
    "11-data-update\\05_update_performance_examples.sql": [
      {
        "statement": "-- ================================================\n-- 05_update_performance_examples.sql\n-- 从 05_update_performance.md 提取的 SQL 示例\n-- 提取时间: 2026-01-23 14:40:17\n-- =====================================",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 大数据量（> 30%）: 分区更新最快\nALTER TABLE users\nREPLACE PARTITION '202401'\nFROM users_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- 单分区: Mutation 较慢，轻量级更新快\n-- 多分区: 分区更新最快，分区越多越快\n\n-- 查看分区数量\nSELECT \n    count(DISTINCT partition) as ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- 使用主键（快速）\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id IN (1, 2, 3)",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- user_id 是主键\n\n-- 避免低选择性条件（慢速）\nALTER TABLE users\nUPDATE status = 'active'\nWHERE status = 'pending'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- status 不是主键\n\n-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- 更新小类型字段（快）\nUPDATE status = 'active'  -- String, 低 cardinality\n\n-- 更新大类型字段（慢）\nUPDAT",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 更新数据\nINSERT INTO users_temp\nSELECT \n    user_id,\n    username,\n    email,\n    'active' as status,\n    created_at,\n    now() as updated_at\nFROM users\nWHERE toYYYYMM(created_at) = '202401'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 替换分区\nALTER TABLE users\nREPLACE PARTITION '202401'\nFROM users_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 清理\nDROP TABLE users_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- 启用轻量级更新\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id IN (1, 2, 3)\nSETTINGS lightweight",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- 分批更新，每次 10 万行\n-- 批次 1\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id BETWEEN 1 AND 10000",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 批次 2\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id BETWEEN 100001 AND 200000",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 继续分批...\n\n-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- 限制并发线程数\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id IN (1, 2, 3)\nSETTINGS",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 限制为 2 个线程\n\n-- 限制内存使用\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id IN (1, 2, 3)\nSETTINGS \n    lightweight_update = 1,\n    max_memory_usage = 10000000000",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 10GB\n\n-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- 使用定时任务在低峰期执行\n-- 例如：每天凌晨 2 点执行\nALTER TABLE users\nUPDATE status = 'inactive'\nWHERE last_log",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- ❌ 低效：低选择性条件\nALTER TABLE users\nUPDATE status = 'active'\nWHERE email LIKE '%@example.com'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ✅ 高效：高选择性条件\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id IN (1, 2, 3, 4, 5)",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- ❌ 低效：不使用分区\nALTER TABLE users\nUPDATE status = 'active'\nWHERE created_at >= '2024-01-01'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ✅ 高效：使用分区裁剪\nALTER TABLE users\nUPDATE status = 'active'\nWHERE toYYYYMM(created_at) = '202401'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- ❌ 低效：更新整个表\nALTER TABLE users\nUPDATE status = 'active'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ✅ 高效：只更新必要的数据\nALTER TABLE users\nUPDATE status = 'active'\nWHERE created_at >= '2024-01-01'\n  AND created_at < '2024-02-01'\n  AND user_id IN (SELECT user_id FROM active_users)",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- 创建表时指定配置\nCREATE TABLE users (\n    user_id UInt64,\n    username String,\n    status String,\n    crea",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- 设置查询级别参数\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id IN (1, 2, 3)\nSETTINGS \n    light",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- 查看 Mutation 进度\nSELECT \n    mutation_id,\n    command,\n    is_done,\n    parts_to_do,\n    parts_to_do",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- 查看 CPU 和内存使用\nSELECT \n    query_id,\n    thread_id,\n    cpu_time_nanoseconds,\n    memory_usage,\n    ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- 查看磁盘读写\nSELECT \n    event_time,\n    read_bytes,\n    write_bytes,\n    read_rows,\n    write_rows\nFROM",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- 查看后台任务队列\nSELECT \n    type,\n    database,\n    table,\n    elapsed,\n    progress,\n    num_parts,\n    ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- 1. 创建临时表\nCREATE TABLE orders_temp AS orders",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 2. 更新数据\nINSERT INTO orders_temp\nSELECT \n    order_id,\n    user_id,\n    product_id,\n    amount * 1.1 as amount,  -- 涨价 10%\n    order_date,\n    status\nFROM orders\nWHERE toYYYYMM(order_date) IN ('2024",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 3. 替换分区\nALTER TABLE orders\nREPLACE PARTITION '202401', '202402', '202403'\nFROM orders_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 4. 清理\nDROP TABLE orders_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- 最新数据使用轻量级更新\nALTER TABLE users\nUPDATE status = 'active'\nWHERE last_login >= now() - INTERVAL 7 DAY\n",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 旧数据使用分区更新\nCREATE TABLE users_temp AS users",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "INSERT INTO users_temp\nSELECT \n    user_id,\n    username,\n    email,\n    'inactive' as status,\n    created_at,\n    last_login\nFROM users\nWHERE last_login < now() - INTERVAL 90 DAY",
        "success": false,
        "result": "HTTP 404: Code: 60. DB::Exception: Table default.users_temp does not exist. Maybe you meant migration_test.users_new?. (UNKNOWN_TABLE) (version 25.12.3.21 (official build))\n"
      },
      {
        "statement": "ALTER TABLE users\nREPLACE PARTITION '202311', '202312'\nFROM users_temp",
        "success": false,
        "result": "HTTP 400: Code: 62. DB::Exception: Syntax error: failed at position 45 (,) (line 2, col 27): , '202312'\nFROM users_temp\n. Expected FROM. (SYNTAX_ERROR) (version 25.12.3.21 (official build))\n"
      },
      {
        "statement": "DROP TABLE users_temp",
        "success": false,
        "result": "HTTP 404: Code: 60. DB::Exception: Table default.users_temp does not exist. Maybe you meant migration_test.users_new?. (UNKNOWN_TABLE) (version 25.12.3.21 (official build))\n"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- 创建分层物化视图\n-- 1. 最近 7 天数据（轻量级更新）\nCREATE MATERIALIZED VIEW users_7d_mv\nENGINE = MergeTree()\nORDER BY ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 2. 最近 30 天数据（分区更新）\nCREATE MATERIALIZED VIEW users_30d_mv\nENGINE = MergeTree()\nORDER BY user_id\nAS SELECT * FROM users\nWHERE created_at >= now() - INTERVAL 30 DAY",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 更新策略\n-- 最新数据: 轻量级更新\nALTER TABLE users\nUPDATE status = 'active'\nWHERE created_at >= now() - INTERVAL 7 DAY\nSETTINGS lightweight_update = 1",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 历史数据: 分区更新\nALTER TABLE users\nREPLACE PARTITION '202401'\nFROM users_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- 原始表设计\nCREATE TABLE events (\n    event_id UInt64,\n    user_id UInt64,\n    event_type String,\n    ev",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 优化后表设计（追加模式）\nCREATE TABLE events_raw (\n    event_id UInt64,\n    user_id UInt64,\n    event_type String,\n    event_data String,\n    event_time DateTime\n) ENGINE = MergeTree()\nORDER BY (user_id, event",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "CREATE TABLE event_updates (\n    event_id UInt64,\n    user_id UInt64,\n    update_type String,\n    update_data String,\n    update_time DateTime\n) ENGINE = MergeTree()\nORDER BY (event_id, update_time)",
        "success": false,
        "result": "HTTP 500: Code: 57. DB::Exception: Table default.event_updates already exists. (TABLE_ALREADY_EXISTS) (version 25.12.3.21 (official build))\n"
      },
      {
        "statement": "-- 查询时合并\nSELECT \n    r.event_id,\n    r.user_id,\n    r.event_type,\n    r.event_data,\n    u.update_type,\n    u.update_data\nFROM events_raw r\nLEFT JOIN (\n    SELECT \n        event_id,\n        argMax(upda",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- 创建物化视图\nCREATE MATERIALIZED VIEW user_stats_mv\nENGINE = SummingMergeTree()\nORDER BY (user_id, date)",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 更新原表，物化视图自动更新\nALTER TABLE events\nUPDATE status = 'processed'\nWHERE event_time >= now() - INTERVAL 7 DAY",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- 创建带 TTL 的表\nCREATE TABLE events (\n    event_id UInt64,\n    user_id UInt64,\n    event_type String,\n ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 更新数据，旧数据自动清理\nALTER TABLE events\nUPDATE status = 'processed'\nWHERE event_time >= now() - INTERVAL 7 DAY",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- 创建跳数索引\nCREATE TABLE events (\n    event_id UInt64,\n    user_id UInt64,\n    event_type String,\n    e",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 创建跳数索引\nALTER TABLE events\nADD INDEX idx_status status\nTYPE set(0)\nGRANULARITY 4",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 更新时使用索引加速\nALTER TABLE events\nUPDATE status = 'processed'\nWHERE status = 'pending'\n  AND event_time >= now() - INTERVAL 7 DAY",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- 创建投影\nALTER TABLE events\nADD PROJECTION p_status (\n    SELECT \n        user_id,\n        event_type,",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 更新数据，投影自动更新\nALTER TABLE events\nUPDATE status = 'processed'\nWHERE status = 'pending'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- 从外部数据更新\n-- 1. 导出需要更新的数据到文件\n-- 2. 使用外部表更新\nCREATE EXTERNAL TABLE updates (\n    user_id UInt64,\n    s",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 执行更新\nALTER TABLE users\nUPDATE status = updates.status\nFROM users\nJOIN updates ON users.user_id = updates.user_id",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- ❌ 错误做法\n-- 每分钟执行一次\nALTER TABLE users UPDATE status = 'active' WHERE user_id = 1",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ✅ 正确做法\n-- 每小时批量执行一次\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id IN (1, 2, 3, ..., 100)",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- ❌ 错误做法\nALTER TABLE users\nUPDATE status = 'active'\nWHERE email LIKE '%@example.com'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ✅ 正确做法\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id IN (1, 2, 3, ..., 100)",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 数据量\n-- ========================================\n\n-- ✅ 正确做法\nALTER TABLE users\nUPDATE status = 'inactive'\nWHERE last_login < now() - INTERVAL 90 DAY\nSET",
        "success": true,
        "result": "Comment - skipped"
      }
    ],
    "11-data-update\\06_update_monitoring_examples.sql": [
      {
        "statement": "-- ================================================\n-- 06_update_monitoring_examples.sql\n-- 从 06_update_monitoring.md 提取的 SQL 示例\n-- 提取时间: 2026-01-23 14:40:17\n-- =======================================",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 更新操作监控\n-- ========================================\n\n-- 查看 CPU 和内存使用\nSELECT \n    query_id,\n    user,\n    query,\n    thread_id,\n    cpu_time_nanoseconds",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 更新操作监控\n-- ========================================\n\n-- 查看磁盘 IO 统计\nSELECT \n    event_time,\n    metric,\n    value\nFROM system.asynchronous_metrics\nWHERE",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 更新操作监控\n-- ========================================\n\n-- 查看后台任务队列\nSELECT \n    type,\n    database,\n    table,\n    elapsed,\n    progress,\n    num_parts,\n ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 更新操作监控\n-- ========================================\n\n-- 查看性能指标\nSELECT \n    event_time,\n    metric,\n    value,\n    description\nFROM system.metrics\nWHERE",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 更新操作监控\n-- ========================================\n\n-- 统计更新操作\nSELECT \n    database,\n    table,\n    count() as mutation_count,\n    sum(if(is_done = 1, ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 更新操作监控\n-- ========================================\n\n-- 分析更新操作的影响\nSELECT \n    database,\n    table,\n    mutation_id,\n    command,\n    parts_to_do,\n    s",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 更新操作监控\n-- ========================================\n\n-- 监控更新操作错误\nSELECT \n    database,\n    table,\n    mutation_id,\n    command,\n    is_done,\n    latest",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 更新操作监控\n-- ========================================\n\n-- 监控 TTL 删除/更新操作\n-- 注意：system.ttl_tables 在某些配置中可能不可用\n-- 替代方案：使用 SHOW CREATE TABLE 或查询 system.part",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 更新操作监控\n-- ========================================\n\n-- 监控分区操作\nSELECT \n    type,\n    partition_id,\n    partition,\n    part_name,\n    rows,\n    bytes_on",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 更新操作监控\n-- ========================================\n\n-- 检查所有 Mutation 的状态\nSELECT \n    database,\n    table,\n    mutation_id,\n    command,\n    is_done,\n ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 更新操作监控\n-- ========================================\n\n-- 检查系统整体负载\nSELECT \n    'CPU Usage' as metric,\n    formatReadableSize(value) as value\nFROM system.",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 更新操作监控\n-- ========================================\n\n-- 检查后台任务队列\nSELECT \n    type,\n    database,\n    table,\n    elapsed,\n    progress,\n    num_parts,\n ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 更新操作监控\n-- ========================================\n\n-- 检查分区状态\nSELECT \n    database,\n    table,\n    partition,\n    sum(rows) as total_rows,\n    sum(byt",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 更新操作监控\n-- ========================================\n\n-- 查看更新历史\nSELECT \n    mutation_id,\n    database,\n    table,\n    command,\n    is_done,\n    parts_to",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 更新操作监控\n-- ========================================\n\n-- 监控批量更新进度\nSELECT \n    database,\n    table,\n    mutation_id,\n    command,\n    is_done,\n    parts_",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 更新操作监控\n-- ========================================\n\n-- 监控 TTL 执行情况\n-- 注意：system.ttl_tables 在某些配置中可能不可用\n-- 替代方案：使用 SHOW CREATE TABLE 查看配置，使用 system.par",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 查看分区变化来推断 TTL 执行情况\nSELECT\n    table,\n    partition,\n    sum(rows) AS total_rows,\n    formatReadableSize(sum(bytes_on_disk)) AS total_size,\n    min(modification_time) AS oldest_part,\n    max(modific",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 更新操作监控\n-- ========================================\n\n-- 综合系统健康检查\nSELECT \n    'Mutation Queue' as metric,\n    count() as value,\n    if(count() < 10, 'OK",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 更新操作监控\n-- ========================================\n\n-- 创建综合监控视图\nCREATE VIEW test_monitoring.update_overview AS\nSELECT \n    'Active Mutations' as metri",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 1. 更新操作监控\n-- ========================================\n\n-- 创建分区操作监控视图\nCREATE VIEW test_monitoring.partition_operations AS\nSELECT \n    type,\n    count() as",
        "success": true,
        "result": "Comment - skipped"
      }
    ],
    "11-data-update\\07_batch_updates_examples.sql": [
      {
        "statement": "-- ================================================\n-- 07_batch_updates_examples.sql\n-- 从 07_batch_updates.md 提取的 SQL 示例\n-- 提取时间: 2026-01-23 14:40:17\n-- ===============================================",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 方案 2: 使用 Mutation（ClickHouse < 23.8）\nALTER TABLE users\nUPDATE status = 'active',\n    status_updated_at = now()\nWHERE user_id IN (\n    SELECT DISTINCT user_id\n    FROM user_logins\n    WHERE login_ti",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 方案 3: 分区更新（如果更新量 > 30%）\n-- 创建临时表\nCREATE TABLE users_temp AS users",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 更新数据\nINSERT INTO users_temp\nSELECT \n    user_id,\n    username,\n    email,\n    'active' as status,\n    status_updated_at,\n    created_at,\n    last_login\nFROM users\nWHERE user_id IN (\n    SELECT DIST",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 替换分区\nALTER TABLE users\nREPLACE PARTITION '202401', '202402'\nFROM users_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 清理\nDROP TABLE users_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 解决方案\n-- ========================================\n\n-- 监控更新进度\nSELECT \n    mutation_id,\n    command,\n    is_done,\n    parts_to_do,\n    progress,\n    created",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 解决方案\n-- ========================================\n\n-- 方案 1: 直接更新（适用于小批量）\nALTER TABLE orders\nUPDATE amount = amount * 1.1,\n    adjusted_at = now()\nWHERE st",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 方案 2: 分批更新（适用于大批量）\n-- 批次 1: 2024年1月\nALTER TABLE orders\nUPDATE amount = amount * 1.1,\n    adjusted_at = now()\nWHERE status = 'pending'\n  AND toYYYYMM(order_date) = '202401'\nSETTINGS max_threads = 4",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 等待完成后执行下一批次\n-- 批次 2: 2024年2月\nALTER TABLE orders\nUPDATE amount = amount * 1.1,\n    adjusted_at = now()\nWHERE status = 'pending'\n  AND toYYYYMM(order_date) = '202402'\nSETTINGS max_threads = 4",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 继续分批...\n\n-- 方案 3: 分区更新（最快速）\n-- 创建临时表\nCREATE TABLE orders_temp AS orders",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 更新数据\nINSERT INTO orders_temp\nSELECT \n    order_id,\n    user_id,\n    product_id,\n    amount * 1.1 as amount,\n    order_date,\n    'pending' as status,\n    adjusted_at,\n    created_at\nFROM orders\nWHER",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 替换分区\nALTER TABLE orders\nREPLACE PARTITION '202401', '202402', '202403'\nFROM orders_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 清理\nDROP TABLE orders_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 解决方案\n-- ========================================\n\n-- 验证更新结果\nSELECT \n    toYYYYMM(order_date) as month,\n    count() as order_count,\n    sum(amount) as tot",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 解决方案\n-- ========================================\n\n-- 创建修正表\nCREATE TABLE events_fixed AS events",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 修正数据\nINSERT INTO events_fixed\nSELECT \n    event_id,\n    user_id,\n    event_type,\n    -- 修正 event_type 的拼写错误\n    multiIf(\n        event_type = 'vew_page', 'view_page',\n        event_type = 'prchase'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 替换分区\nALTER TABLE events\nREPLACE PARTITION '202401', '202402', '202403'\nFROM events_fixed",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 验证修正结果\nSELECT \n    event_type,\n    count() as count\nFROM events\nWHERE toYYYYMM(event_time) BETWEEN '202401' AND '202403'\nGROUP BY event_type\nORDER BY count DESC",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 清理\nDROP TABLE events_fixed",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 解决方案\n-- ========================================\n\n-- 方案 1: 使用 CASE WHEN 更新\nALTER TABLE users\nUPDATE level = CASE\n    WHEN total_spent >= 100000 THEN 'pla",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 方案 2: 使用临时表\n-- 创建临时表\nCREATE TABLE users_temp AS users",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 更新等级\nINSERT INTO users_temp\nSELECT \n    user_id,\n    username,\n    email,\n    status,\n    total_spent,\n    CASE\n        WHEN total_spent >= 100000 THEN 'platinum'\n        WHEN total_spent >= 50000 ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 替换分区\nALTER TABLE users\nREPLACE PARTITION '202401', '202402'\nFROM users_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 清理\nDROP TABLE users_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 解决方案\n-- ========================================\n\n-- 验证等级升级\nSELECT \n    level,\n    count() as user_count,\n    min(total_spent) as min_spent,\n    max(tota",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 解决方案\n-- ========================================\n\n-- 创建归档表\nCREATE TABLE orders_archive (\n    order_id UInt64,\n    user_id UInt64,\n    product_id UInt64,\n",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 使用 EXCHANGE PARTITIONS 移动数据\nALTER TABLE orders_archive\nEXCHANGE PARTITION '202301'\nWITH orders",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "ALTER TABLE orders_archive\nEXCHANGE PARTITION '202302'\nWITH orders",
        "success": false,
        "result": "HTTP 400: Code: 62. DB::Exception: Syntax error: failed at position 28 (EXCHANGE) (line 2, col 1): EXCHANGE PARTITION '202302'\nWITH orders\n. Expected one of: ON, a list of ALTER commands, ALTER command, ADD COL"
      },
      {
        "statement": "ALTER TABLE orders_archive\nEXCHANGE PARTITION '202303'\nWITH orders",
        "success": false,
        "result": "HTTP 400: Code: 62. DB::Exception: Syntax error: failed at position 28 (EXCHANGE) (line 2, col 1): EXCHANGE PARTITION '202303'\nWITH orders\n. Expected one of: ON, a list of ALTER commands, ALTER command, ADD COL"
      },
      {
        "statement": "-- 继续交换其他月份...\n\n-- 验证归档\nSELECT \n    toYYYYMM(order_date) as month,\n    count() as order_count,\n    sum(amount) as total_amount\nFROM orders_archive\nWHERE toYYYYMM(order_date) BETWEEN '202301' AND '2023",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 解决方案\n-- ========================================\n\n-- 创建临时表\nCREATE TABLE events_temp AS events",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 更新最近 3 个月的数据\nINSERT INTO events_temp\nSELECT \n    event_id,\n    user_id,\n    event_type,\n    event_data,\n    1 as processed,\n    now() as processed_at\nFROM events\nWHERE toYYYYMM(event_time) IN (\n   ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 替换分区\nALTER TABLE events\nREPLACE PARTITION \n    toYYYYMM(now() - INTERVAL 1 MONTH),\n    toYYYYMM(now() - INTERVAL 2 MONTH),\n    toYYYYMM(now() - INTERVAL 3 MONTH)\nFROM events_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 清理\nDROP TABLE events_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 解决方案\n-- ========================================\n\n-- 方案 1: 使用子查询更新\nALTER TABLE users\nUPDATE total_spent = (\n    SELECT coalesce(sum(amount), 0)\n    FROM ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 方案 2: 使用临时表（更高效）\n-- 创建临时表\nCREATE TABLE user_stats_temp AS users",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 计算统计数据\nINSERT INTO user_stats_temp\nSELECT \n    u.user_id,\n    u.username,\n    u.email,\n    u.status,\n    coalesce(o.total_spent, 0) as total_spent,\n    coalesce(o.order_count, 0) as total_orders,\n ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 替换分区\nALTER TABLE users\nREPLACE PARTITION '202401'\nFROM user_stats_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 清理\nDROP TABLE user_stats_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 解决方案\n-- ========================================\n\n-- 方案 1: 使用轻量级更新\nALTER TABLE events\nUPDATE is_deleted = 1,\n    deleted_at = now()\nWHERE event_time < to",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 方案 2: 分区更新\n-- 创建临时表\nCREATE TABLE events_temp AS events",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 标记为已删除\nINSERT INTO events_temp\nSELECT \n    event_id,\n    user_id,\n    event_type,\n    event_data,\n    event_time,\n    1 as is_deleted,\n    now() as deleted_at,\n    processed,\n    processed_at\nFROM ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 替换分区\nALTER TABLE events\nREPLACE PARTITION '202301', '202302', '202303'\nFROM events_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 清理\nDROP TABLE events_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 解决方案\n-- ========================================\n\n-- 批量更新前先备份\nCREATE TABLE users_backup AS users",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 执行更新\nALTER TABLE users UPDATE ...",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 验证结果\n-- 如果有问题，可以从备份恢复\n-- DROP TABLE users",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- RENAME TABLE users_backup TO users",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 解决方案\n-- ========================================\n\n-- 将大批量更新拆分为小批次\n-- 每批次 10 万行\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id BETWEEN 1 AND 100",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 等待完成后再执行下一批次\nALTER TABLE users\nUPDATE status = 'active'\nWHERE user_id BETWEEN 100001 AND 200000",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 继续分批...\n\n-- ========================================\n-- 解决方案\n-- ========================================\n\n-- 实时监控更新进度\nSELECT \n    mutation_id,\n    command,\n    is_done,\n    parts_to_do,\n    progres",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 解决方案\n-- ========================================\n\n-- 更新完成后验证结果\nSELECT \n    status,\n    count() as count,\n    countIf(updated_at >= now() - INTERVAL 1 HOU",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 解决方案\n-- ========================================\n\n-- 更新完成后及时清理临时表\nDROP TABLE IF EXISTS users_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "DROP TABLE IF EXISTS orders_temp",
        "success": true,
        "result": ""
      },
      {
        "statement": "DROP TABLE IF EXISTS events_temp",
        "success": true,
        "result": ""
      }
    ],
    "11-data-update\\08_case_studies_examples.sql": [
      {
        "statement": "-- ================================================\n-- 08_case_studies_examples.sql\n-- 从 08_case_studies.md 提取的 SQL 示例\n-- 提取时间: 2026-01-23 14:40:17\n-- ================================================\n",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 订单事件表（记录状态变更）\nCREATE TABLE order_events (\n    event_id UInt64,\n    order_id UInt64,\n    from_status String,\n    to_status String,\n    event_time DateTime,\n    event_data String\n) ENGINE = Replicate",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方案设计\n-- ========================================\n\n-- 1. 使用轻量级更新（每小时）\n-- 更新超时未支付的订单\nALTER TABLE orders\nUPDATE order_status = 'cancelled',\n    updated_at =",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 2. 使用物化视图自动计算\n-- 创建订单状态统计物化视图\nCREATE MATERIALIZED VIEW order_status_stats_mv\nENGINE = SummingMergeTree()\nORDER BY (toYYYYMM(order_time), order_status)\nAS SELECT\n    toYYYYMM(order_time) as month,\n ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 3. 使用分区更新（每日归档）\n-- 将已完成的订单移动到归档表\nCREATE TABLE orders_archive AS orders",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "ALTER TABLE orders_archive\nEXCHANGE PARTITION toYYYYMM(now() - INTERVAL 3 MONTH)\nWITH orders",
        "success": false,
        "result": "HTTP 400: Code: 62. DB::Exception: Syntax error: failed at position 28 (EXCHANGE) (line 2, col 1): EXCHANGE PARTITION toYYYYMM(now() - INTERVAL 3 MONTH)\nWITH orders\n. Expected one of: ON, a list of ALTER comman"
      },
      {
        "statement": "-- ========================================\n-- 方案设计\n-- ========================================\n\n-- 创建跳数索引加速查询\nALTER TABLE orders\nADD INDEX idx_status order_status\nTYPE set(0)\nGRANULARITY 4",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 限制更新范围（只更新最近数据）\nALTER TABLE orders\nUPDATE order_status = 'cancelled'\nWHERE order_status = 'pending'\n  AND order_time >= now() - INTERVAL 1 HOUR\n  AND order_time < now() - INTERVAL 30 MINUTE\nSETTING",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方案设计\n-- ========================================\n\n-- 监控更新进度\nSELECT \n    mutation_id,\n    command,\n    is_done,\n    parts_to_do,\n    progress\nFROM system.",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 验证更新结果\nSELECT \n    order_status,\n    count() as order_count,\n    countIf(updated_at >= now() - INTERVAL 1 HOUR) as updated_count\nFROM orders\nWHERE order_time >= now() - INTERVAL 24 HOUR\nGROUP BY or",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方案设计\n-- ========================================\n\n-- 交易表结构\nCREATE TABLE transactions (\n    transaction_id UInt64,\n    user_id UInt64,\n    account_id UInt",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方案设计\n-- ========================================\n\n-- 1. 创建临时表\nCREATE TABLE transactions_temp AS transactions",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 2. 逐月修正数据（每月独立处理）\n-- 2023年1月\nINSERT INTO transactions_temp\nSELECT \n    transaction_id,\n    user_id,\n    account_id,\n    amount_original,\n    -- 修正汇率（假设USD/CNY从7.0改为7.2）\n    amount_original * 7.2 as",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 替换分区\nALTER TABLE transactions\nREPLACE PARTITION '202301'\nFROM transactions_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 清空临时表准备下个月\nTRUNCATE TABLE transactions_temp",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 继续处理其他月份...\n-- 2023年2月\nINSERT INTO transactions_temp\nSELECT \n    transaction_id,\n    user_id,\n    account_id,\n    amount_original,\n    amount_original * 7.2 as exchange_rate,\n    amount_original * ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "ALTER TABLE transactions\nREPLACE PARTITION '202302'\nFROM transactions_temp",
        "success": false,
        "result": "HTTP 404: Code: 60. DB::Exception: Could not find table: transactions. (UNKNOWN_TABLE) (version 25.12.3.21 (official build))\n"
      },
      {
        "statement": "TRUNCATE TABLE transactions_temp",
        "success": false,
        "result": "HTTP 404: Code: 60. DB::Exception: Table default.transactions_temp does not exist. (UNKNOWN_TABLE) (version 25.12.3.21 (official build))\n"
      },
      {
        "statement": "-- 继续处理3-12月...\n\n-- 3. 验证修正结果\nSELECT \n    toYYYYMM(transaction_time) as month,\n    currency,\n    count() as transaction_count,\n    sum(amount_converted) as total_converted,\n    avg(exchange_rate) as a",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方案设计\n-- ========================================\n\n-- 更新前备份\nCREATE TABLE transactions_backup_202301 AS transactions\nSELECT *\nFROM transactions\nWHERE toYYY",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 如果需要回滚\nDROP TABLE transactions",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "RENAME TABLE transactions_backup TO transactions",
        "success": false,
        "result": "HTTP 404: Code: 60. DB::Exception: Table `default`.`transactions_backup` doesn't exist. (UNKNOWN_TABLE) (version 25.12.3.21 (official build))\n"
      },
      {
        "statement": "-- 或者只恢复特定分区\nALTER TABLE transactions\nDROP PARTITION '202301'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "ALTER TABLE transactions\nATTACH PARTITION '202301'\nFROM transactions_backup",
        "success": false,
        "result": "HTTP 404: Code: 60. DB::Exception: Could not find table: transactions. (UNKNOWN_TABLE) (version 25.12.3.21 (official build))\n"
      },
      {
        "statement": "-- ========================================\n-- 方案设计\n-- ========================================\n\n-- 日志表结构\nCREATE TABLE logs (\n    log_id UInt64,\n    user_id UInt64,\n    log_type String,\n    log_data S",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 处理统计表\nCREATE TABLE log_processing_stats (\n    stat_date Date,\n    processed_count UInt64,\n    unprocessed_count UInt64,\n    error_count UInt64\n) ENGINE = SummingMergeTree()\nORDER BY stat_date",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方案设计\n-- ========================================\n\n-- 1. 轻量级更新标记已处理的日志\nALTER TABLE logs\nUPDATE processed = 1,\n    processed_at = now()\nWHERE processed = 0",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 2. 更新统计表\nINSERT INTO log_processing_stats\nSELECT \n    toDate(now()) as stat_date,\n    sum(processed) as processed_count,\n    sum(1 - processed) as unprocessed_count,\n    0 as error_count\nFROM logs\n",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方案设计\n-- ========================================\n\n-- 重新设计为追加模式\n-- 原始日志表（只追加，不更新）\nCREATE TABLE logs_raw (\n    log_id UInt64,\n    user_id UInt64,\n    log_t",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 处理事件表（记录处理状态）\nCREATE TABLE log_processing_events (\n    event_id UInt64,\n    log_id UInt64,\n    event_type String,  -- processed, error\n    event_time DateTime,\n    event_data String\n) ENGINE = Repl",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 查询时合并（获取最新处理状态）\nSELECT \n    r.log_id,\n    r.user_id,\n    r.log_type,\n    r.log_data,\n    r.log_time,\n    if(\n        e.event_type = 'processed',\n        1,\n        0\n    ) as processed,\n    e.event",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方案设计\n-- ========================================\n\n-- 用户基本信息表（稳定数据）\nCREATE TABLE users_base (\n    user_id UInt64,\n    username String,\n    email String,\n ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 用户画像表（频繁更新）\nCREATE TABLE user_profiles (\n    user_id UInt64,\n    tags Array(String),\n    interests Array(String),\n    activity_level String,\n    last_active DateTime,\n    updated_at DateTime\n) ENGI",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 用户画像变更日志\nCREATE TABLE user_profile_changes (\n    change_id UInt64,\n    user_id UInt64,\n    change_type String,  -- add_tag, remove_tag, update_level\n    change_value String,\n    change_time DateTim",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方案设计\n-- ========================================\n\n-- 1. 轻量级更新用户画像\nALTER TABLE user_profiles\nUPDATE tags = arrayAppend(tags, 'premium'),\n    interests = a",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 2. 记录变更日志\nINSERT INTO user_profile_changes\nSELECT \n    rowNumberInAllBlocks() as change_id,\n    user_id,\n    'add_tag' as change_type,\n    'premium' as change_value,\n    now() as change_time\nFROM (",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 3. 定期合并（使用 ReplacingMergeTree）\nOPTIMIZE TABLE user_profiles\nFINAL",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方案设计\n-- ========================================\n\n-- 查询用户画像（使用 argMax 获取最新版本）\nSELECT \n    user_id,\n    tags,\n    interests,\n    activity_level,\n    argMa",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方案设计\n-- ========================================\n\n-- 事实表\nCREATE TABLE sales_facts (\n    sale_id UInt64,\n    product_id UInt64,\n    customer_id UInt64,\n  ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ETL 日志表\nCREATE TABLE etl_logs (\n    log_id UInt64,\n    source_system String,\n    target_table String,\n    records_processed UInt64,\n    records_updated UInt64,\n    records_inserted UInt64,\n    star",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方案设计\n-- ========================================\n\n-- 1. 创建临时表\nCREATE TABLE sales_facts_temp AS sales_facts",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 2. 从外部数据源加载数据\n-- 假设数据已导出到 CSV 文件\nINSERT INTO sales_facts_temp\nFROM file('sales_202401.csv', 'CSV')\nSETTINGS \n    input_format_null_as_default = 1,\n    date_time_input_format = 'best_effort'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 3. 使用 INSERT SELECT 合并数据（自动去重）\nINSERT INTO sales_facts\nSELECT \n    sale_id,\n    product_id,\n    customer_id,\n    amount,\n    sale_date,\n    store_id,\n    now() as etl_updated_at,\n    'source_system",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 4. 使用 DeduplicationMergeTree 去重\n-- 或者手动删除重复数据\n-- （见 09-data-deletion/ 专题）\n\n-- 5. 记录 ETL 日志\nINSERT INTO etl_logs\nVALUES (\n    1,\n    'source_system_name',\n    'sales_facts',\n    (SELECT count() FROM",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方案设计\n-- ========================================\n\n-- 1. 使用分区裁剪\nINSERT INTO sales_facts\nSELECT * FROM sales_facts_temp\nWHERE sale_date = '2024-01-01'",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 每天单独处理\n\n-- 2. 并行加载\n-- 使用多个 ClickHouse 客户端并行加载不同日期的数据\n\n-- 3. 批量插入\n-- 每批插入 10 万条，减少网络开销",
        "success": true,
        "result": "Comment - skipped"
      }
    ]
  }
}