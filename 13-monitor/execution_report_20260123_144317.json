{
  "timestamp": "2026-01-23T14:43:17.774290",
  "directory": "13-monitor",
  "summary": {
    "total_files": 9,
    "total_statements": 216,
    "total_success": 216,
    "total_errors": 0
  },
  "results": {
    "13-monitor\\01_system_monitoring_examples.sql": [
      {
        "statement": "-- ================================================\n-- 01_system_monitoring_examples.sql\n-- 从 01_system_monitoring.md 提取的 SQL 示例\n-- 提取时间: 2026-01-23 14:40:17\n-- =======================================",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- CPU 使用趋势（最近 1 小时）\nSELECT\n    toStartOfMinute(event_time) AS minute,\n    avg(value) AS avg_cpu_usage,\n    max(value) AS max_cpu_usage,\n    min(value) AS min_cpu_usage\nFROM system.asynchronous_metric",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 查询 CPU 消耗 Top 10\nSELECT\n    user,\n    query_id,\n    formatReadableSize(read_bytes) AS read_bytes,\n    formatReadableSize(written_bytes) AS written_bytes,\n    query_duration_ms / 1000 AS duration_se",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 使用率\n-- ========================================\n\n-- 高 CPU 使用率查询\nSELECT\n    user,\n    count() AS query_count,\n    sum(query_duration_ms) / 1000 AS tot",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 使用率\n-- ========================================\n\n-- 当前内存使用情况\nSELECT\n    metric,\n    formatReadableQuantity(value) AS readable_value\nFROM system.async",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 内存使用趋势\nSELECT\n    toStartOfMinute(event_time) AS minute,\n    avg(value) AS avg_memory_usage,\n    max(value) AS max_memory_usage\nFROM system.asynchronous_metrics_log\nWHERE metric = 'OSMemoryActive'\n",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 查询内存消耗 Top 10\nSELECT\n    user,\n    query_id,\n    formatReadableSize(memory_usage) AS memory_usage,\n    query_duration_ms / 1000 AS duration_sec,\n    substring(query, 1, 200) AS query\nFROM system.qu",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 使用率\n-- ========================================\n\n-- 高内存使用查询\nSELECT\n    user,\n    count() AS query_count,\n    sum(memory_usage) AS total_memory_usage,",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 内存泄漏检测\nSELECT\n    user,\n    query_id,\n    memory_usage,\n    query_duration_ms,\n    substring(query, 1, 300) AS query\nFROM system.query_log\nWHERE type = 'QueryFinish'\n  AND event_date >= today()\n  A",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 使用率\n-- ========================================\n\n-- 磁盘空间使用\nSELECT\n    name AS disk_name,\n    formatReadableSize(total_space) AS total_space,\n    form",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 表空间使用 Top 10\nSELECT\n    database,\n    table,\n    formatReadableSize(sum(bytes_on_disk)) AS total_size,\n    count() AS part_count\nFROM system.parts\nWHERE active\nGROUP BY database, table\nORDER BY sum",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 数据库空间使用\nSELECT\n    database,\n    formatReadableSize(sum(bytes_on_disk)) AS total_size,\n    count() AS table_count,\n    count(DISTINCT table) AS distinct_tables\nFROM system.parts\nWHERE active\nGROUP ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 使用率\n-- ========================================\n\n-- 磁盘读写统计\nSELECT\n    metric,\n    sum(value) AS total_value,\n    formatReadableQuantity(sum(value)) A",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 磁盘 I/O 趋势\nSELECT\n    toStartOfMinute(event_time) AS minute,\n    sumIf(value, metric = 'OSReadBytes') AS read_bytes,\n    sumIf(value, metric = 'OSWriteBytes') AS write_bytes\nFROM system.events_log\nW",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 使用率\n-- ========================================\n\n-- 磁盘空间不足告警\nSELECT\n    name AS disk_name,\n    available_space * 100.0 / total_space AS available_per",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 大表检测\nSELECT\n    database,\n    table,\n    formatReadableSize(sum(bytes_on_disk)) AS total_size,\n    sum(rows) AS total_rows,\n    count() AS part_count\nFROM system.parts\nWHERE active\n  AND bytes_on_d",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 使用率\n-- ========================================\n\n-- 网络流量统计\nSELECT\n    metric,\n    formatReadableQuantity(sum(value)) AS total_value\nFROM system.event",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 网络流量趋势\nSELECT\n    toStartOfMinute(event_time) AS minute,\n    sumIf(value, metric = 'NetworkReceiveBytes') AS receive_bytes,\n    sumIf(value, metric = 'NetworkSendBytes') AS send_bytes\nFROM system.e",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 远程查询统计\nSELECT\n    remote_address,\n    count() AS query_count,\n    sum(read_bytes) AS total_read_bytes,\n    sum(written_bytes) AS total_written_bytes,\n    avg(query_duration_ms) AS avg_duration_ms\nF",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 使用率\n-- ========================================\n\n-- 集群节点状态\nSELECT\n    cluster,\n    shard_num,\n    replica_num,\n    host_name,\n    port,\n    errors_co",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 副本同步状态\nSELECT\n    database,\n    table,\n    replica_name,\n    is_leader,\n    is_readonly,\n    absolute_delay,\n    queue_size,\n    total_replicated_bytes,\n    total_replication_lag_bytes\nFROM system.",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ZooKeeper 连接状态\nSELECT\n    host,\n    port,\n    index,\n    connected,\n    operation_mode,\n    avg_latency_ms,\n    version\nFROM system.zookeeper\nWHERE connected = 0",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 使用率\n-- ========================================\n\n-- 分布式表状态\nSELECT\n    database,\n    table,\n    cluster,\n    shard_num,\n    replica_num,\n    host_name",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 分布式查询性能\nSELECT\n    cluster,\n    count() AS query_count,\n    avg(query_duration_ms) AS avg_duration_ms,\n    max(query_duration_ms) AS max_duration_ms,\n    sum(read_bytes) AS total_read_bytes\nFROM sy",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 使用率\n-- ========================================\n\n-- 创建系统健康视图\nCREATE VIEW monitoring.system_health AS\nSELECT\n    now() AS timestamp,\n    'CPU' AS metr",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 使用率\n-- ========================================\n\n-- 创建资源趋势视图\nCREATE VIEW monitoring.resource_trends AS\nSELECT\n    toStartOfMinute(event_time) AS minu",
        "success": true,
        "result": "Comment - skipped"
      }
    ],
    "13-monitor\\02_query_monitoring_examples.sql": [
      {
        "statement": "-- ================================================\n-- 02_query_monitoring_examples.sql\n-- 从 02_query_monitoring.md 提取的 SQL 示例\n-- 提取时间: 2026-01-23 14:40:17\n-- =========================================",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 慢查询统计（按用户）\nSELECT\n    user,\n    count() AS slow_query_count,\n    avg(query_duration_ms) / 1000 AS avg_duration_sec,\n    max(query_duration_ms) / 1000 AS max_duration_sec,\n    sum(query_duration_ms)",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 慢查询趋势（每小时）\nSELECT\n    toStartOfHour(event_time) AS hour,\n    count() AS query_count,\n    countIf(query_duration_ms > 5000) AS slow_query_count,\n    countIf(query_duration_ms > 30000) AS very_slow_q",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 基础慢查询检测\n-- ========================================\n\n-- 慢查询资源消耗分析\nSELECT\n    user,\n    query_id,\n    query_duration_ms / 1000 AS duration_sec,\n    read_r",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 慢查询特征分析\nSELECT\n    user,\n    substring(query, 1, 100) AS query_pattern,\n    count() AS slow_count,\n    avg(query_duration_ms) / 1000 AS avg_duration_sec,\n    avg(read_rows) AS avg_read_rows,\n    av",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 基础慢查询检测\n-- ========================================\n\n-- 全表扫描查询\nSELECT\n    query_id,\n    user,\n    query_duration_ms,\n    read_rows,\n    result_rows,\n    ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 全表扫描频率统计\nSELECT\n    user,\n    count() AS full_scan_count,\n    sum(read_rows) AS total_read_rows,\n    sum(read_bytes) AS total_read_bytes\nFROM system.query_log\nWHERE type = 'QueryFinish'\n  AND event",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 高吞吐量全表扫描\nSELECT\n    query_id,\n    user,\n    read_rows,\n    read_bytes,\n    query_duration_ms,\n    read_rows / (query_duration_ms / 1000) AS rows_per_second,\n    substring(query, 1, 300) AS query\nFR",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 基础慢查询检测\n-- ========================================\n\n-- 低效 JOIN 查询\nSELECT\n    query_id,\n    user,\n    query_duration_ms,\n    read_rows,\n    read_bytes,\n ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- JOIN 查询统计（按类型）\nSELECT\n    CASE\n        WHEN query ILIKE '%INNER JOIN%' THEN 'INNER JOIN'\n        WHEN query ILIKE '%LEFT JOIN%' THEN 'LEFT JOIN'\n        WHEN query ILIKE '%RIGHT JOIN%' THEN 'RIGHT ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 大表 JOIN 检测\nSELECT\n    query_id,\n    user,\n    substring(query, 1, 300) AS query,\n    query_duration_ms,\n    read_rows,\n    read_bytes\nFROM system.query_log\nWHERE type = 'QueryFinish'\n  AND query IL",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 基础慢查询检测\n-- ========================================\n\n-- 检测不使用分布式表的 JOIN\nSELECT\n    query_id,\n    user,\n    query_duration_ms,\n    read_rows,\n    substrin",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 检测跨库 JOIN\nSELECT\n    query_id,\n    user,\n    query_duration_ms,\n    substring(query, 1, 500) AS query\nFROM system.query_log\nWHERE type = 'QueryFinish'\n  AND query ILIKE '%JOIN%'\n  AND query_duratio",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 基础慢查询检测\n-- ========================================\n\n-- 失败查询统计（最近 24 小时）\nSELECT\n    exception_code,\n    exception_text,\n    count() AS error_count,\n    a",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 失败查询趋势\nSELECT\n    toStartOfHour(event_time) AS hour,\n    count() AS error_count,\n    countIf(exception_code = 0) AS timeout_count,\n    countIf(exception_code != 0) AS other_error_count\nFROM system.",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 用户错误查询统计\nSELECT\n    user,\n    exception_text,\n    count() AS error_count\nFROM system.query_log\nWHERE type = 'ExceptionWhileProcessing'\n  AND event_date >= today()\nGROUP BY user, exception_text\nORDE",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 基础慢查询检测\n-- ========================================\n\n-- 超时查询统计\nSELECT\n    user,\n    count() AS timeout_count,\n    max(query_duration_ms) / 1000 AS max_ti",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 超时查询模式\nSELECT\n    user,\n    substring(query, 1, 200) AS query_pattern,\n    count() AS timeout_count\nFROM system.query_log\nWHERE type = 'QueryFinish'\n  AND event_date >= today()\n  AND exception_code",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 基础慢查询检测\n-- ========================================\n\n-- 检测 Transaction 表 JOIN\nSELECT\n    query_id,\n    user,\n    query_duration_ms,\n    read_rows,\n    re",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- Transaction 表 JOIN 统计\nSELECT\n    user,\n    count() AS transaction_join_count,\n    avg(query_duration_ms) / 1000 AS avg_duration_sec,\n    sum(read_rows) AS total_read_rows\nFROM system.query_log\nWHER",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 基础慢查询检测\n-- ========================================\n\n-- ✅ 正确做法：使用子查询代替 JOIN\n-- ❌ 错误做法\nSELECT t1.*, t2.*\nFROM transactions t1\nJOIN events t2 ON t1.id = t2",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ✅ 正确做法：使用分布式表或物化视图\n-- ❌ 错误做法\nSELECT *\nFROM transactions t1\nLEFT JOIN transactions t2 ON t1.parent_id = t2.id",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 基础慢查询检测\n-- ========================================\n\n-- 检测未使用排序键的 WHERE 条件\nSELECT\n    query_id,\n    user,\n    database,\n    table,\n    query_duration_ms,",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 检测全表扫描查询\nSELECT\n    query_id,\n    user,\n    read_rows,\n    read_bytes,\n    query_duration_ms,\n    substring(query, 1, 300) AS query\nFROM system.query_log\nWHERE type = 'QueryFinish'\n  AND read_rows ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 索引使用效率分析\nSELECT\n    database,\n    table,\n    sorting_key,\n    partition_key,\n    primary_key,\n    total_rows,\n    total_bytes\nFROM system.tables\nWHERE database NOT IN ('system', 'information_schema",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 基础慢查询检测\n-- ========================================\n\n-- 高基数 DISTINCT 查询\nSELECT\n    query_id,\n    user,\n    query_duration_ms,\n    read_rows,\n    result_r",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- DISTINCT 查询统计\nSELECT\n    user,\n    count() AS distinct_count,\n    avg(query_duration_ms) / 1000 AS avg_duration_sec,\n    avg(read_rows) AS avg_read_rows\nFROM system.query_log\nWHERE type = 'QueryFin",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 基础慢查询检测\n-- ========================================\n\n-- ✅ 正确做法：使用 groupBitmap 代替 COUNT(DISTINCT)\n-- ❌ 错误做法\nSELECT COUNT(DISTINCT user_id) AS unique_users",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ✅ 正确做法\nSELECT uniqExact(user_id) AS unique_users\nFROM events",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ✅ 更好的做法：使用 groupBitmap\nSELECT uniqHLL12(user_id) AS unique_users\nFROM events",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 基础慢查询检测\n-- ========================================\n\n-- 低效子查询检测\nSELECT\n    query_id,\n    user,\n    query_duration_ms,\n    substring(query, 1, 500) AS que",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 嵌套子查询检测\nSELECT\n    query_id,\n    user,\n    query_duration_ms,\n    length(query) AS query_length,\n    substring(query, 1, 300) AS query\nFROM system.query_log\nWHERE type = 'QueryFinish'\n  AND query_d",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 基础慢查询检测\n-- ========================================\n\n-- 高成本 ORDER BY 查询\nSELECT\n    query_id,\n    user,\n    query_duration_ms,\n    read_rows,\n    substrin",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ORDER BY 内存使用\nSELECT\n    query_id,\n    user,\n    query_duration_ms,\n    memory_usage,\n    formatReadableSize(memory_usage) AS readable_memory_usage,\n    substring(query, 1, 300) AS query\nFROM syste",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 基础慢查询检测\n-- ========================================\n\n-- 创建查询性能汇总视图\nCREATE VIEW monitoring.query_performance_summary AS\nSELECT\n    toStartOfHour(event_tim",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 基础慢查询检测\n-- ========================================\n\n-- 创建反模式检测视图\nCREATE VIEW monitoring.query_anti_patterns AS\nSELECT\n    'Full table scan' AS pattern_t",
        "success": true,
        "result": "Comment - skipped"
      }
    ],
    "13-monitor\\03_data_quality_monitoring_examples.sql": [
      {
        "statement": "-- ================================================\n-- 03_data_quality_monitoring_examples.sql\n-- 从 03_data_quality_monitoring.md 提取的 SQL 示例\n-- 提取时间: 2026-01-23 14:40:17\n-- ===========================",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 计算分区倾斜度\nSELECT\n    database,\n    table,\n    partition_key,\n    count() AS partition_count,\n    max(partition_rows) AS max_partition_rows,\n    min(partition_rows) AS min_partition_rows,\n    avg(part",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 分区倾斜度最高的表\nSELECT\n    database,\n    table,\n    partition_key,\n    skew_ratio,\n    partition_count\nFROM (\n    SELECT\n        database,\n        table,\n        partition_key,\n        count() AS partiti",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 检测分区不均衡\n-- ========================================\n\n-- 查找分区键不合理的表\nSELECT\n    database,\n    table,\n    engine,\n    partition_key,\n    sorting_key,\n    to",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 建议的分区键配置\nSELECT\n    database,\n    table,\n    current_partition_key,\n    recommended_partition_key,\n    reason\nFROM (\n    -- 基于时间的表建议按日期分区\n    SELECT\n        database,\n        table,\n        partiti",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 检测分区不均衡\n-- ========================================\n\n-- 检测过期分区\nSELECT\n    database,\n    table,\n    partition,\n    sum(rows) AS rows,\n    sum(bytes_on_dis",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 分区 TTL 配置检查\nSELECT\n    database,\n    table,\n    partition_key,\n    engine,\n    partition_ttl_is_set,\n    data_ttl_is_set\nFROM (\n    SELECT\n        database,\n        table,\n        partition_key,\n  ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 检测分区不均衡\n-- ========================================\n\n-- 查找排序键设计不合理的表\nSELECT\n    database,\n    table,\n    engine,\n    sorting_key,\n    primary_key,\n    to",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 排序键利用率分析\nSELECT\n    database,\n    table,\n    sorting_key,\n    total_rows,\n    total_bytes,\n    avg(marks) AS avg_marks,\n    avg(granules) AS avg_granules\nFROM system.parts\nWHERE active\n  AND databa",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 检测分区不均衡\n-- ========================================\n\n-- 查询是否使用排序键\nSELECT\n    query_id,\n    user,\n    substring(query, 1, 300) AS query,\n    read_rows,\n  ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 检测分区不均衡\n-- ========================================\n\n-- 查找缺少索引的大表\nSELECT\n    database,\n    table,\n    engine,\n    total_rows,\n    total_bytes,\n    format",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 索引使用效率\nSELECT\n    database,\n    table,\n    name AS index_name,\n    type,\n    expr,\n    marks,\n    granules,\n    formatReadableSize(bytes_on_disk) AS bytes_on_disk\nFROM system.data_skipping_indices\n",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 检测分区不均衡\n-- ========================================\n\n-- 分析索引命中率\nSELECT\n    database,\n    table,\n    name AS index_name,\n    marks,\n    granules,\n    mark",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 检测分区不均衡\n-- ========================================\n\n-- 查找主键设计不合理的表\nSELECT\n    database,\n    table,\n    engine,\n    primary_key,\n    sorting_key,\n    tot",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 主键唯一性检查\nSELECT\n    database,\n    table,\n    primary_key,\n    total_rows,\n    estimated_distinct_values,\n    total_rows / greatest(estimated_distinct_values, 1) AS uniqueness_ratio,\n    CASE\n       ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 检测分区不均衡\n-- ========================================\n\n-- 分区倾斜分析\nSELECT\n    database,\n    table,\n    partition,\n    sum(rows) AS rows,\n    sum(bytes_on_dis",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 严重倾斜的分区\nSELECT\n    database,\n    table,\n    partition,\n    partition_bytes,\n    avg_bytes,\n    partition_bytes / avg_bytes AS skew_ratio\nFROM (\n    SELECT\n        database,\n        table,\n        p",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 检测分区不均衡\n-- ========================================\n\n-- 数据分布分析\nSELECT\n    database,\n    table,\n    count() AS part_count,\n    sum(rows) AS total_rows,\n  ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- Part 大小分布\nSELECT\n    database,\n    table,\n    count() AS part_count,\n    min(bytes_on_disk) AS min_bytes,\n    max(bytes_on_disk) AS max_bytes,\n    avg(bytes_on_disk) AS avg_bytes,\n    formatReadabl",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 检测分区不均衡\n-- ========================================\n\n-- 高空值率列检测\nSELECT\n    database,\n    table,\n    name AS column_name,\n    type,\n    default_kind,\n    ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 检测分区不均衡\n-- ========================================\n\n-- 不合理的数据类型\nSELECT\n    database,\n    table,\n    name AS column_name,\n    type,\n    default_kind,\n   ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 检测分区不均衡\n-- ========================================\n\n-- 创建数据质量汇总视图\nCREATE VIEW monitoring.data_quality_summary AS\nSELECT\n    'Partition Skew' AS quality_",
        "success": true,
        "result": "Comment - skipped"
      }
    ],
    "13-monitor\\04_operation_monitoring_examples.sql": [
      {
        "statement": "-- ================================================\n-- 04_operation_monitoring_examples.sql\n-- 从 04_operation_monitoring.md 提取的 SQL 示例\n-- 提取时间: 2026-01-23 14:40:17\n-- =================================",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ALTER 操作趋势（最近 7 天）\nSELECT\n    toDate(event_time) AS date,\n    count() AS alter_count,\n    sum(query_duration_ms) / 1000 AS total_duration_sec,\n    avg(query_duration_ms) / 1000 AS avg_duration_sec\n",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ALTER 操作类型统计\nSELECT\n    CASE\n        WHEN query ILIKE 'ALTER TABLE%ADD%' THEN 'ADD'\n        WHEN query ILIKE 'ALTER TABLE%DROP%' THEN 'DROP'\n        WHEN query ILIKE 'ALTER TABLE%MODIFY%' THEN 'MOD",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- ALTER 操作统计\n-- ========================================\n\n-- 检测同一表的频繁 ALTER 操作\nSELECT\n    database,\n    table,\n    user,\n    count() AS alter_count,\n    su",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 检测短时间内的频繁 ALTER\nSELECT\n    user,\n    database,\n    count() AS alter_count,\n    min(event_time) AS first_time,\n    max(event_time) AS last_time,\n    dateDiff('minute', first_time, last_time) AS dura",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- ALTER 操作统计\n-- ========================================\n\n-- 长时间运行的 ALTER 操作\nSELECT\n    query_id,\n    user,\n    query_duration_ms / 1000 AS duration_sec,\n ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ALTER 操作影响分析\nSELECT\n    user,\n    database,\n    count() AS alter_count,\n    sum(query_duration_ms) / 1000 AS total_duration_sec,\n    avg(read_rows) AS avg_read_rows,\n    avg(written_rows) AS avg_wr",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- ALTER 操作统计\n-- ========================================\n\n-- MUTATION 操作统计\nSELECT\n    command,\n    status,\n    count() AS mutation_count,\n    sum(failures)",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 活跃的 MUTATION 操作\nSELECT\n    database,\n    table,\n    command,\n    mutation_id,\n    status,\n    created_at,\n    progress * 100 AS progress_percent,\n    parts_to_do,\n    parts_to_do_names\nFROM system.",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- MUTATION 操作历史\nSELECT\n    toDate(created_at) AS date,\n    command,\n    count() AS mutation_count,\n    avg(mutate_part_rows) AS avg_mutate_rows,\n    sum(failures) AS total_failures\nFROM system.mutati",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- ALTER 操作统计\n-- ========================================\n\n-- 长时间运行的 MUTATION\nSELECT\n    database,\n    table,\n    command,\n    mutation_id,\n    created_at,\n",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 影响 MUTATION 性能的因素分析\nSELECT\n    database,\n    table,\n    sum(mutate_part_rows) AS total_mutate_rows,\n    avg(mutate_part_rows) AS avg_mutate_rows,\n    sum(failures) AS total_failures,\n    count() AS",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- ALTER 操作统计\n-- ========================================\n\n-- DELETE 操作统计（通过 MUTATION）\nSELECT\n    database,\n    table,\n    command,\n    count() AS delete_co",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- DELETE 操作趋势\nSELECT\n    toDate(created_at) AS date,\n    database,\n    count() AS delete_count,\n    sum(mutate_part_rows) AS total_deleted_rows\nFROM system.mutations\nWHERE created_at >= today() - INT",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 高频 DELETE 检测\nSELECT\n    database,\n    table,\n    user,\n    count() AS delete_count,\n    sum(mutate_part_rows) AS total_deleted_rows\nFROM system.mutations AS m\nJOIN system.query_log AS q\n    ON m.da",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- ALTER 操作统计\n-- ========================================\n\n-- 大规模 DELETE 操作\nSELECT\n    database,\n    table,\n    command,\n    mutation_id,\n    mutate_part_ro",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- DELETE 影响分析\nSELECT\n    database,\n    table,\n    count() AS delete_count,\n    sum(mutate_part_rows) AS total_deleted_rows,\n    formatReadableSize(sum(mutate_part_rows * avg_row_size)) AS estimated_s",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- ALTER 操作统计\n-- ========================================\n\n-- INSERT 操作统计\nSELECT\n    user,\n    database,\n    count() AS insert_count,\n    sum(written_rows) ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 慢 INSERT 操作\nSELECT\n    query_id,\n    user,\n    database,\n    written_rows,\n    written_bytes,\n    query_duration_ms / 1000 AS duration_sec,\n    written_rows / (query_duration_ms / 1000) AS rows_per",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- INSERT 批次大小分析\nSELECT\n    user,\n    count() AS insert_count,\n    avg(written_rows) AS avg_batch_size,\n    min(written_rows) AS min_batch_size,\n    max(written_rows) AS max_batch_size,\n    quantile(0",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- ALTER 操作统计\n-- ========================================\n\n-- 检测小批次 INSERT\nSELECT\n    user,\n    database,\n    count() AS small_batch_count,\n    avg(written_",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- INSERT 频率分析\nSELECT\n    user,\n    toStartOfMinute(event_time) AS minute,\n    count() AS insert_count,\n    sum(written_rows) AS total_written_rows\nFROM system.query_log\nWHERE type = 'QueryFinish'\n  A",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- ALTER 操作统计\n-- ========================================\n\n-- OPTIMIZE 操作统计\nSELECT\n    user,\n    database,\n    count() AS optimize_count,\n    sum(query_dura",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 频繁 OPTIMIZE 检测\nSELECT\n    database,\n    table,\n    count() AS optimize_count,\n    avg(query_duration_ms) / 1000 AS avg_duration_sec,\n    any(substring(query, 1, 200)) AS example_query\nFROM system.q",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- ALTER 操作统计\n-- ========================================\n\n-- TRUNCATE 操作统计\nSELECT\n    user,\n    database,\n    count() AS truncate_count,\n    avg(query_dura",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- TRUNCATE 操作历史\nSELECT\n    toDate(event_time) AS date,\n    user,\n    count() AS truncate_count\nFROM system.query_log\nWHERE type = 'QueryFinish'\n  AND event_date >= today() - INTERVAL 30 DAY\n  AND que",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- ALTER 操作统计\n-- ========================================\n\n-- DROP 操作统计\nSELECT\n    user,\n    count() AS drop_count,\n    countIf(query ILIKE '%DROP TABLE%') ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- DROP 操作详细记录\nSELECT\n    user,\n    event_time,\n    substring(query, 1, 300) AS query\nFROM system.query_log\nWHERE type = 'QueryFinish'\n  AND event_date >= today()\n  AND query ILIKE 'DROP%'\nORDER BY ev",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- ALTER 操作统计\n-- ========================================\n\n-- 创建操作汇总视图\nCREATE VIEW monitoring.operation_summary AS\nSELECT\n    now() AS timestamp,\n    'ALTER",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 创建高频操作告警视图\nCREATE VIEW monitoring.high_frequency_operations AS\nSELECT\n    user,\n    database,\n    operation_type,\n    count() AS operation_count,\n    sum(query_duration_ms) / 1000 AS total_duration",
        "success": true,
        "result": "Comment - skipped"
      }
    ],
    "13-monitor\\05_abuse_detection_examples.sql": [
      {
        "statement": "-- ================================================\n-- 05_abuse_detection_examples.sql\n-- 从 05_abuse_detection.md 提取的 SQL 示例\n-- 提取时间: 2026-01-23 14:40:17\n-- ===========================================",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 按数据库统计非复制表\nSELECT\n    database,\n    count() AS non_replicated_count,\n    sum(total_rows) AS total_rows,\n    sum(total_bytes) AS total_bytes,\n    formatReadableSize(sum(total_bytes)) AS readable_siz",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 按引擎类型统计\nSELECT\n    engine,\n    count() AS table_count,\n    sum(total_rows) AS total_rows,\n    sum(total_bytes) AS total_bytes,\n    formatReadableSize(sum(total_bytes)) AS readable_size\nFROM system.",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 查找所有非复制表\n-- ========================================\n\n-- 大型非复制表（超过 10GB）\nSELECT\n    database,\n    table,\n    engine,\n    total_rows,\n    total_bytes,\n   ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 非复制表数据增长趋势（需要配合历史数据）\nSELECT\n    database,\n    table,\n    engine,\n    total_bytes,\n    formatReadableSize(total_bytes) AS current_size\nFROM system.tables\nWHERE database NOT IN ('system', 'informatio",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 查找所有非复制表\n-- ========================================\n\n-- 查询非复制表的统计\nSELECT\n    query_id,\n    user,\n    substring(query, 1, 300) AS query,\n    read_rows,\n ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 按用户统计非复制表查询\nSELECT\n    user,\n    count() AS query_count,\n    sum(query_duration_ms) / 1000 AS total_duration_sec,\n    sum(read_bytes) AS total_read_bytes\nFROM system.query_log\nWHERE type = 'QueryFi",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 查找所有非复制表\n-- ========================================\n\n-- 检测所有包含 Transaction 的 JOIN 查询\nSELECT\n    query_id,\n    user,\n    query_duration_ms,\n    read_rows",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- Transaction 表 JOIN 统计（按用户）\nSELECT\n    user,\n    count() AS transaction_join_count,\n    avg(query_duration_ms) / 1000 AS avg_duration_sec,\n    max(query_duration_ms) / 1000 AS max_duration_sec,\n    ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- Transaction 表 JOIN 趋势（每小时）\nSELECT\n    toStartOfHour(event_time) AS hour,\n    count() AS transaction_join_count,\n    avg(query_duration_ms) / 1000 AS avg_duration_sec,\n    sum(read_rows) AS total_re",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 查找所有非复制表\n-- ========================================\n\n-- 慢速 Transaction 表 JOIN 查询\nSELECT\n    query_id,\n    user,\n    query_duration_ms,\n    read_rows,\n  ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 高资源消耗 Transaction 表 JOIN\nSELECT\n    query_id,\n    user,\n    query_duration_ms,\n    read_bytes,\n    memory_usage,\n    formatReadableSize(read_bytes) AS readable_read_bytes,\n    formatReadableSize(me",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 查找所有非复制表\n-- ========================================\n\n-- 高频小查询检测\nSELECT\n    user,\n    count() AS query_count,\n    avg(read_rows) AS avg_read_rows,\n    av",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- QPS 过高检测\nSELECT\n    toStartOfMinute(event_time) AS minute,\n    count() AS qps,\n    countIf(query_duration_ms > 1000) AS slow_query_count,\n    avg(query_duration_ms) AS avg_duration_ms\nFROM system.q",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 按用户统计高频查询\nSELECT\n    user,\n    toStartOfMinute(event_time) AS minute,\n    count() AS query_count\nFROM system.query_log\nWHERE type = 'QueryFinish'\n  AND event_date >= today()\nGROUP BY user, minute\nH",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 查找所有非复制表\n-- ========================================\n\n-- 全表扫描查询\nSELECT\n    query_id,\n    user,\n    query_duration_ms,\n    read_rows,\n    result_rows,\n   ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 全表扫描用户统计\nSELECT\n    user,\n    count() AS full_scan_count,\n    sum(read_rows) AS total_read_rows,\n    avg(query_duration_ms) AS avg_duration_ms\nFROM system.query_log\nWHERE type = 'QueryFinish'\n  AND",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 全表扫描趋势\nSELECT\n    toStartOfHour(event_time) AS hour,\n    count() AS full_scan_count,\n    sum(read_rows) AS total_read_rows\nFROM system.query_log\nWHERE type = 'QueryFinish'\n  AND event_date >= today",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 查找所有非复制表\n-- ========================================\n\n-- 高内存消耗查询\nSELECT\n    query_id,\n    user,\n    query_duration_ms,\n    memory_usage,\n    formatReadab",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 高内存用户统计\nSELECT\n    user,\n    count() AS high_memory_count,\n    sum(memory_usage) AS total_memory_usage,\n    formatReadableSize(sum(memory_usage)) AS readable_total_memory,\n    avg(query_duration_ms",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 内存泄漏检测（长时间运行且高内存）\nSELECT\n    query_id,\n    user,\n    query_duration_ms,\n    memory_usage,\n    query_duration_ms / 1000 AS duration_sec,\n    substring(query, 1, 300) AS query\nFROM system.query_log\nW",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 查找所有非复制表\n-- ========================================\n\n-- 高 CPU 消耗查询（长时间运行）\nSELECT\n    query_id,\n    user,\n    query_duration_ms,\n    read_rows,\n    writt",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 高 CPU 用户统计\nSELECT\n    user,\n    count() AS high_cpu_count,\n    sum(query_duration_ms) / 1000 AS total_duration_sec,\n    avg(query_duration_ms) AS avg_duration_ms\nFROM system.query_log\nWHERE type = ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 查找所有非复制表\n-- ========================================\n\n-- 非工作时间查询（周末或晚上 10 点到早上 8 点）\nSELECT\n    user,\n    count() AS off_hour_query_count,\n    avg(query_d",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 异常时间大查询\nSELECT\n    user,\n    event_time,\n    query_duration_ms,\n    read_rows,\n    substring(query, 1, 300) AS query\nFROM system.query_log\nWHERE type = 'QueryFinish'\n  AND event_date >= today() - I",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 查找所有非复制表\n-- ========================================\n\n-- 查询来自新 IP 的访问（需要历史数据对比）\nSELECT\n    remote_address,\n    count() AS query_count,\n    any(user) AS u",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 高频访问 IP\nSELECT\n    remote_address,\n    user,\n    count() AS query_count,\n    sum(query_duration_ms) / 1000 AS total_duration_sec\nFROM system.query_log\nWHERE type = 'QueryFinish'\n  AND event_date >=",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 查找所有非复制表\n-- ========================================\n\n-- 访问敏感表的查询（需要根据实际业务定义敏感表）\nSELECT\n    user,\n    database,\n    table,\n    count() AS access_count,\n ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 大量数据导出检测\nSELECT\n    user,\n    count() AS export_query_count,\n    sum(written_rows) AS total_written_rows,\n    sum(written_bytes) AS total_written_bytes,\n    formatReadableSize(sum(written_bytes)) A",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 查找所有非复制表\n-- ========================================\n\n-- 创建滥用检测汇总视图\nCREATE VIEW monitoring.abuse_detection_summary AS\nSELECT\n    'Non-replicated tables' ",
        "success": true,
        "result": "Comment - skipped"
      }
    ],
    "13-monitor\\06_alerting_examples.sql": [
      {
        "statement": "-- ================================================\n-- 06_alerting_examples.sql\n-- 从 06_alerting.md 提取的 SQL 示例\n-- 提取时间: 2026-01-23 14:40:17\n-- ================================================\n\n\n-- ===",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 持续高 CPU 告警\nSELECT\n    now() AS timestamp,\n    'CPU' AS resource_type,\n    'Sustained High Usage' AS alert_type,\n    'CRITICAL' AS level,\n    avg(value) AS current_value,\n    80 AS threshold\nFROM sy",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 告警\n-- ========================================\n\n-- 内存使用率告警\nSELECT\n    'Memory' AS resource_type,\n    'High Usage' AS alert_type,\n    'CRITICAL' AS le",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- OOM 风险告警\nSELECT\n    now() AS timestamp,\n    'Memory' AS resource_type,\n    'OOM Risk' AS alert_type,\n    'CRITICAL' AS level,\n    (SELECT value FROM system.asynchronous_metrics WHERE metric = 'OSMe",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 告警\n-- ========================================\n\n-- 磁盘空间告警\nSELECT\n    name AS disk_name,\n    'Disk' AS resource_type,\n    'Low Space' AS alert_type,\n ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 磁盘空间不足告警\nSELECT\n    now() AS timestamp,\n    name AS disk_name,\n    'Disk' AS resource_type,\n    'Critical Low Space' AS alert_type,\n    'CRITICAL' AS level,\n    available_space * 100.0 / total_spac",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 告警\n-- ========================================\n\n-- 副本延迟告警\nSELECT\n    database,\n    table,\n    replica_name,\n    'Replication' AS resource_type,\n    '",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 副本同步失败告警\nSELECT\n    database,\n    table,\n    replica_name,\n    'Replication' AS resource_type,\n    'Sync Failure' AS alert_type,\n    'CRITICAL' AS level,\n    queue_size AS queue_size,\n    errors_co",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 告警\n-- ========================================\n\n-- ZooKeeper 连接失败告警\nSELECT\n    host,\n    port,\n    'ZooKeeper' AS resource_type,\n    'Connection Lost",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 告警\n-- ========================================\n\n-- 慢查询告警\nSELECT\n    now() AS timestamp,\n    user,\n    query_id,\n    'Query' AS resource_type,\n    'Sl",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 超慢查询告警\nSELECT\n    now() AS timestamp,\n    user,\n    query_id,\n    'Query' AS resource_type,\n    'Very Slow Query' AS alert_type,\n    'CRITICAL' AS level,\n    query_duration_ms / 1000 AS duration_se",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 告警\n-- ========================================\n\n-- 查询超时告警\nSELECT\n    now() AS timestamp,\n    user,\n    query_id,\n    'Query' AS resource_type,\n    'Q",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 告警\n-- ========================================\n\n-- 高内存查询告警\nSELECT\n    now() AS timestamp,\n    user,\n    query_id,\n    'Query' AS resource_type,\n    '",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 高 CPU 查询告警（长时间运行）\nSELECT\n    now() AS timestamp,\n    user,\n    query_id,\n    'Query' AS resource_type,\n    'Long Running Query' AS alert_type,\n    'WARNING' AS level,\n    query_duration_ms / 1000 A",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 告警\n-- ========================================\n\n-- 分区倾斜告警\nSELECT\n    now() AS timestamp,\n    database,\n    table,\n    'Data Quality' AS resource_type",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 严重分区倾斜告警\nSELECT\n    now() AS timestamp,\n    database,\n    table,\n    'Data Quality' AS resource_type,\n    'Severe Partition Skew' AS alert_type,\n    'CRITICAL' AS level,\n    skew_ratio AS current_r",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 告警\n-- ========================================\n\n-- 大型非复制表告警\nSELECT\n    now() AS timestamp,\n    database,\n    table,\n    'Data Quality' AS resource_ty",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 告警\n-- ========================================\n\n-- 频繁 ALTER 告警\nSELECT\n    now() AS timestamp,\n    user,\n    database,\n    'Operation' AS resource_typ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 告警\n-- ========================================\n\n-- 大规模 DELETE 告警\nSELECT\n    now() AS timestamp,\n    database,\n    table,\n    'Operation' AS resource_",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 告警\n-- ========================================\n\n-- 创建综合告警视图\nCREATE VIEW monitoring.alerts AS\nSELECT\n    now() AS timestamp,\n    'System' AS category,",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 告警\n-- ========================================\n\n-- 创建告警历史视图（需要配合历史数据表）\nCREATE VIEW monitoring.alert_history AS\nSELECT\n    timestamp,\n    category,\n  ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 告警\n-- ========================================\n\n-- 创建告警配置表\nCREATE TABLE IF NOT EXISTS monitoring.alert_config (\n    category String,\n    resource Str",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 插入告警配置\nINSERT INTO monitoring.alert_config (category, resource, alert_type, level, threshold, enabled, description) VALUES\n('System', 'CPU', 'High Usage', 'WARNING', '80', 1, 'CPU 使用率超过 80%'),\n('Sy",
        "success": true,
        "result": "Comment - skipped"
      }
    ],
    "13-monitor\\07_best_practices_examples.sql": [
      {
        "statement": "-- ================================================\n-- 07_best_practices_examples.sql\n-- 从 07_best_practices.md 提取的 SQL 示例\n-- 提取时间: 2026-01-23 14:40:17\n-- =============================================",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ✅ 最佳实践：使用异步指标减少查询开销\nSELECT\n    toStartOfMinute(event_time) AS minute,\n    avg(value) AS avg_cpu_usage,\n    max(value) AS max_cpu_usage,\n    min(value) AS min_cpu_usage\nFROM system.asynchronous_metr",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 监控\n-- ========================================\n\n-- ✅ 最佳实践：监控内存使用率和 OOM 风险\nCREATE VIEW monitoring.memory_health AS\nSELECT\n    now() AS timestamp,\n    ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ✅ 最佳实践：监控查询内存消耗\nSELECT\n    user,\n    count() AS high_memory_count,\n    sum(memory_usage) AS total_memory_usage,\n    formatReadableSize(sum(memory_usage)) AS readable_total_memory\nFROM system.query_",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 监控\n-- ========================================\n\n-- ✅ 最佳实践：监控磁盘空间和增长趋势\nCREATE VIEW monitoring.disk_health AS\nSELECT\n    now() AS timestamp,\n    name A",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ✅ 最佳实践：预测磁盘空间耗尽时间\nSELECT\n    name AS disk_name,\n    available_space,\n    -- 假设每天增长 1GB\n    available_space / (1024 * 1024 * 1024) AS days_until_full,\n    toDateTime(now() + INTERVAL (available_spac",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 监控\n-- ========================================\n\n-- ✅ 最佳实践：监控集群健康状态\nCREATE VIEW monitoring.cluster_health AS\nSELECT\n    cluster,\n    shard_num,\n    re",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ✅ 最佳实践：监控副本同步状态\nCREATE VIEW monitoring.replication_health AS\nSELECT\n    database,\n    table,\n    replica_name,\n    is_leader,\n    is_readonly,\n    absolute_delay,\n    queue_size,\n    CASE\n        W",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 监控\n-- ========================================\n\n-- ✅ 最佳实践：使用分位数统计慢查询分布\nSELECT\n    user,\n    count() AS total_queries,\n    quantile(0.5)(query_duratio",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ✅ 最佳实践：监控慢查询趋势\nCREATE TABLE monitoring.slow_query_stats (\n    date Date,\n    hour UInt8,\n    total_queries UInt64,\n    slow_queries UInt64,\n    avg_duration_ms Float64,\n    p95_duration_ms Float64\n",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 监控\n-- ========================================\n\n-- ✅ 最佳实践：识别重复查询（可优化为缓存）\nSELECT\n    normalized_query,\n    count() AS query_count,\n    sum(query_durat",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 监控\n-- ========================================\n\n-- ✅ 最佳实践：监控分区均衡性\nCREATE VIEW monitoring.partition_balance AS\nSELECT\n    database,\n    table,\n    par",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 监控\n-- ========================================\n\n-- ✅ 最佳实践：监控复制表覆盖率\nCREATE VIEW monitoring.replication_coverage AS\nSELECT\n    database,\n    count() AS",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 监控\n-- ========================================\n\n-- ✅ 最佳实践：使用多级告警阈值\nCREATE TABLE monitoring.alert_thresholds (\n    category String,\n    resource Strin",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 插入告警阈值\nINSERT INTO monitoring.alert_thresholds VALUES\n('System', 'CPU', 'usage_percent', 80, 90, 600),       -- 持续 10 分钟\n('System', 'Memory', 'usage_percent', 85, 95, 300),    -- 持续 5 分钟\n('System',",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 持续 5 分钟\n\n-- ========================================\n-- CPU 监控\n-- ========================================\n\n-- ✅ 最佳实践：实现告警抑制机制\nCREATE VIEW monitoring.suppressed_alerts AS\nSELECT\n    a.*,\n    'Suppr",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 监控\n-- ========================================\n\n-- ✅ 最佳实践：根据告警级别配置不同的通知策略\nCREATE TABLE monitoring.notification_policies (\n    level String,\n    chann",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 插入通知策略\nINSERT INTO monitoring.notification_policies VALUES\n('CRITICAL', ['pagerduty', 'sms', 'slack', 'email'], 0, 3),\n('WARNING', ['slack', 'email'], 300, 1),  -- 延迟 5 分钟\n('INFO', ['email'], 3600,",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 延迟 1 小时\n\n-- ========================================\n-- CPU 监控\n-- ========================================\n\n-- ❌ 错误做法：频繁查询 system.query_log\nSELECT\n    user,\n    count() AS query_count\nFROM system.q",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ✅ 正确做法：使用物化视图预聚合\nCREATE MATERIALIZED VIEW monitoring.query_stats_mv\nENGINE = SummingMergeTree()\nPARTITION BY toYYYYMM(event_date)\nORDER BY (event_date, user)\nAS SELECT\n    event_date,\n    user,\n   ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ✅ 正确做法：查询预聚合的数据\nSELECT\n    user,\n    sum(query_count) AS query_count\nFROM monitoring.query_stats_mv\nWHERE event_date >= today()\nGROUP BY user",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 监控\n-- ========================================\n\n-- ✅ 最佳实践：为查询日志设置 TTL\nCREATE TABLE IF NOT EXISTS system.query_log (\n    type Enum8('QueryStart' = 1, ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 保留 30 天\n\n-- ✅ 最佳实践：定期清理旧数据\nOPTIMIZE TABLE system.query_log FINAL",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 监控\n-- ========================================\n\n-- ✅ 最佳实践：监控异常访问\nCREATE VIEW monitoring.security_alerts AS\nSELECT\n    user,\n    remote_address,\n    c",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 监控\n-- ========================================\n\n-- ✅ 最佳实践：监控敏感表访问\nCREATE VIEW monitoring.sensitive_data_access AS\nSELECT\n    user,\n    database,\n    ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- CPU 监控\n-- ========================================\n\n-- ✅ 最佳实践：创建定期维护表\nCREATE TABLE IF NOT EXISTS monitoring.maintenance_schedule (\n    id UInt64,\n    res",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ✅ 最佳实践：记录维护窗口\nINSERT INTO monitoring.maintenance_schedule VALUES\n(1, 'cluster', '2026-01-22 02:00:00', '2026-01-22 04:00:00', 'Scheduled maintenance', 'admin')",
        "success": true,
        "result": "Comment - skipped"
      }
    ],
    "13-monitor\\08_common_configs_examples.sql": [
      {
        "statement": "-- ================================================\n-- 08_common_configs_examples.sql\n-- 从 08_common_configs.md 提取的 SQL 示例\n-- 提取时间: 2026-01-23 14:40:17\n-- =============================================",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 创建基础监控视图\nCREATE VIEW monitoring.basic_metrics AS\nSELECT\n    now() AS timestamp,\n    'CPU' AS metric_type,\n    'Usage' AS metric_name,\n    (SELECT value FROM system.asynchronous_metrics WHERE metric",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 3. 基础监控视图\n-- ========================================\n\n-- 创建监控数据库\nCREATE DATABASE IF NOT EXISTS monitoring",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 系统资源监控视图\nCREATE VIEW monitoring.system_resources AS\nSELECT\n    now() AS timestamp,\n    'CPU' AS resource_type,\n    'Usage' AS metric_name,\n    (SELECT value FROM system.asynchronous_metrics WHERE m",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 查询性能监控视图\nCREATE VIEW monitoring.query_performance AS\nSELECT\n    toStartOfMinute(event_time) AS minute,\n    count() AS total_queries,\n    countIf(query_duration_ms < 100) AS very_fast_queries,\n    c",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 表健康监控视图\nCREATE VIEW monitoring.table_health AS\nSELECT\n    database,\n    table,\n    engine,\n    total_rows,\n    total_bytes,\n    formatReadableSize(total_bytes) AS readable_size,\n    count() AS part",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 3. 基础监控视图\n-- ========================================\n\n-- 创建告警配置表\nCREATE TABLE IF NOT EXISTS monitoring.alert_config (\n    id UInt64,\n    category String",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 插入告警配置\nINSERT INTO monitoring.alert_config (id, category, resource, alert_type, level, threshold, duration_interval, enabled, description) VALUES\n-- 系统告警\n(1, 'System', 'CPU', 'High Usage', 'WARNING",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 3. 基础监控视图\n-- ========================================\n\n-- 创建预聚合物化视图\nCREATE MATERIALIZED VIEW monitoring.query_stats_hourly\nENGINE = SummingMergeTree()\nPA",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- 创建慢查询预聚合\nCREATE MATERIALIZED VIEW monitoring.slow_query_stats_hourly\nENGINE = SummingMergeTree()\nPARTITION BY toYYYYMM(date)\nORDER BY (date, hour, user)\nAS SELECT\n    toDate(event_time) AS date,\n  ",
        "success": true,
        "result": "Comment - skipped"
      }
    ],
    "13-monitor\\top_cpu_queries_examples.sql": [
      {
        "statement": "-- ================================================\n-- top_cpu_queries_examples.sql\n-- 从 top_cpu_queries.md 提取的 SQL 示例\n-- 提取时间: 2026-01-23 14:40:17\n-- ================================================\n",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方法 1: 使用 query_duration_ms 估算（简单）\n-- ========================================\n\n-- 方法 2: 使用 query_thread_log 获取线程级别的 CPU 时间\n-- 这个方法更准确，因为它记录了实际 CPU 使用时间\nS",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方法 1: 使用 query_duration_ms 估算（简单）\n-- ========================================\n\n-- 方法 3: 综合考虑 CPU 时间、查询时间、读取行数等多个指标\nSELECT\n    query_id,\n    user,\n    sum",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方法 1: 使用 query_duration_ms 估算（简单）\n-- ========================================\n\n-- 方法 4: 按用户统计 CPU 使用情况\nSELECT\n    user,\n    count() AS query_count,\n    s",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方法 1: 使用 query_duration_ms 估算（简单）\n-- ========================================\n\n-- 方法 5: 识别重复的高 CPU 查询（可优化为缓存）\nSELECT\n    normalized_query,\n    count() AS",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方法 1: 使用 query_duration_ms 估算（简单）\n-- ========================================\n\n-- 方法 6: 找出 CPU 利用率高的查询\n-- CPU 利用率 = 总 CPU 时间 / 查询执行时间\nSELECT\n    query_id",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方法 1: 使用 query_duration_ms 估算（简单）\n-- ========================================\n\n-- 方法 7: 分析过去24小时内 CPU 使用趋势\nSELECT\n    toStartOfHour(event_time) AS hour,\n",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方法 1: 使用 query_duration_ms 估算（简单）\n-- ========================================\n\n-- 方法 8: 找出 CPU 使用率最高的用户\nSELECT\n    user,\n    count() AS query_count,\n    ",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方法 1: 使用 query_duration_ms 估算（简单）\n-- ========================================\n\n-- 方法 9: 找出既慢又高 CPU 的查询（最需要优化的查询）\nSELECT\n    query_id,\n    user,\n    sum(c",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方法 1: 使用 query_duration_ms 估算（简单）\n-- ========================================\n\n-- 方法 10: 分析 CPU 使用与读取数据的比例（查询效率）\nSELECT\n    query_id,\n    user,\n    sum(c",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方法 1: 使用 query_duration_ms 估算（简单）\n-- ========================================\n\n-- 推荐：使用 query_thread_log 获取准确的 CPU 时间\nSELECT\n    q.query_id,\n    q.user,\n",
        "success": true,
        "result": "Comment - skipped"
      },
      {
        "statement": "-- ========================================\n-- 方法 1: 使用 query_duration_ms 估算（简单）\n-- ========================================\n\n-- 简化版本：使用查询执行时间估算\nSELECT\n    query_id,\n    user,\n    query_duration_ms / ",
        "success": true,
        "result": "Comment - skipped"
      }
    ]
  }
}