# æ•°æ®åˆ é™¤ä¸“é¢˜

æœ¬ä¸“é¢˜ä»‹ç» ClickHouse ä¸­å„ç§æ•°æ®åˆ é™¤æ–¹æ³•ã€ç­–ç•¥å’Œæœ€ä½³å®è·µã€‚

## ğŸ“š æ–‡æ¡£ç›®å½•

### åˆ é™¤æ–¹æ³•
- [01_partition_deletion.md](./01_partition_deletion.md) - åˆ†åŒºåˆ é™¤ï¼ˆæ¨èï¼‰
- [02_ttl_deletion.md](./02_ttl_deletion.md) - TTL è‡ªåŠ¨åˆ é™¤
- [03_mutation_deletion.md](./03_mutation_deletion.md) - Mutation åˆ é™¤
- [04_lightweight_deletion.md](./04_lightweight_deletion.md) - è½»é‡çº§åˆ é™¤

### ç­–ç•¥å’Œä¼˜åŒ–
- [05_deletion_strategies.md](./05_deletion_strategies.md) - åˆ é™¤ç­–ç•¥é€‰æ‹©
- [06_deletion_performance.md](./06_deletion_performance.md) - åˆ é™¤æ€§èƒ½ä¼˜åŒ–
- [07_deletion_monitoring.md](./07_deletion_monitoring.md) - åˆ é™¤ç›‘æ§

## ğŸ¯ å¿«é€Ÿå¼€å§‹

### æ–¹æ³• 1: åˆ†åŒºåˆ é™¤ï¼ˆæ¨èï¼‰

```sql
-- åˆ é™¤æ•´ä¸ªåˆ†åŒºï¼ˆæœ€å¿«ï¼‰
ALTER TABLE your_table
DROP PARTITION '2023-01';
```

### æ–¹æ³• 2: TTL è‡ªåŠ¨åˆ é™¤

```sql
-- åˆ›å»ºè¡¨æ—¶è®¾ç½® TTL
CREATE TABLE your_table (
    id UInt64,
    event_time DateTime,
    data String
) ENGINE = MergeTree
PARTITION BY toYYYYMM(event_time)
ORDER BY id
TTL event_time + INTERVAL 90 DAY;
```

### æ–¹æ³• 3: Mutation åˆ é™¤

```sql
-- åˆ é™¤ç‰¹å®šæ¡ä»¶çš„æ•°æ®
ALTER TABLE your_table
DELETE WHERE event_time < '2023-01-01';
```

### æ–¹æ³• 4: è½»é‡çº§åˆ é™¤ï¼ˆClickHouse 23.8+ï¼‰

```sql
-- è½»é‡çº§åˆ é™¤ï¼ˆå¼‚æ­¥ï¼‰
ALTER TABLE your_table
DELETE WHERE event_time < '2023-01-01'
SETTINGS lightweight_delete = 1;
```

## ğŸ“Š åˆ é™¤æ–¹æ³•å¯¹æ¯”

| æ–¹æ³• | é€Ÿåº¦ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|---------|------|------|
| åˆ†åŒºåˆ é™¤ | â­â­â­â­â­ | åˆ é™¤å¤§é‡å†å²æ•°æ® | å³æ—¶ã€é«˜æ•ˆã€æ— é¢å¤–å¼€é”€ | åªèƒ½æŒ‰åˆ†åŒºåˆ é™¤ |
| TTL è‡ªåŠ¨åˆ é™¤ | â­â­â­â­ | å®šæœŸæ¸…ç†æ—§æ•°æ® | è‡ªåŠ¨åŒ–ã€æ— éœ€æ‰‹åŠ¨å¹²é¢„ | å»¶è¿Ÿåˆ é™¤ã€éœ€è¦åˆç†é…ç½® |
| Mutation åˆ é™¤ | â­â­ | åˆ é™¤å°‘é‡æ•°æ® | çµæ´»ã€å¯æŒ‰æ¡ä»¶åˆ é™¤ | é‡æ“ä½œã€æ€§èƒ½å½±å“å¤§ |
| è½»é‡çº§åˆ é™¤ | â­â­â­â­ | ClickHouse 23.8+ | å¼‚æ­¥ã€æ€§èƒ½å½±å“å° | éœ€è¦æ–°ç‰ˆã€æ”¯æŒæœ‰é™ |

## ğŸ¯ é€‰æ‹©æŒ‡å—

### ä½¿ç”¨åˆ†åŒºåˆ é™¤å½“ï¼š
- éœ€è¦åˆ é™¤æ•´ä¸ªåˆ†åŒºçš„æ•°æ®
- åˆ†åŒºé”®å¯ä»¥è¦†ç›–åˆ é™¤æ¡ä»¶
- è¿½æ±‚æœ€å¿«çš„åˆ é™¤é€Ÿåº¦
- ä¸éœ€è¦ä¿ç•™éƒ¨åˆ†æ•°æ®

### ä½¿ç”¨ TTL è‡ªåŠ¨åˆ é™¤å½“ï¼š
- æœ‰å›ºå®šçš„æ•°æ®ä¿ç•™ç­–ç•¥
- éœ€è¦å®šæœŸè‡ªåŠ¨æ¸…ç†
- ä¸æƒ³æ‰‹åŠ¨æ‰§è¡Œåˆ é™¤æ“ä½œ
- å¯ä»¥æ¥å—åˆ é™¤å»¶è¿Ÿ

### ä½¿ç”¨ Mutation åˆ é™¤å½“ï¼š
- éœ€è¦åˆ é™¤å°‘é‡æ•°æ®
- åˆ é™¤æ¡ä»¶å¤æ‚ï¼ˆéåˆ†åŒºé”®ï¼‰
- éœ€è¦ç²¾ç¡®æ§åˆ¶åˆ é™¤æ—¶æœº
- ä¸åœ¨æ„åˆ é™¤æœŸé—´çš„æ€§èƒ½å½±å“

### ä½¿ç”¨è½»é‡çº§åˆ é™¤å½“ï¼š
- ä½¿ç”¨ ClickHouse 23.8 æˆ–æ›´é«˜ç‰ˆæœ¬
- éœ€è¦åˆ é™¤å°‘é‡æˆ–ä¸­ç­‰é‡æ•°æ®
- å¸Œæœ›åˆ é™¤æ“ä½œå¼‚æ­¥æ‰§è¡Œ
- å¯ä»¥æ¥å—æœ€ç»ˆä¸€è‡´æ€§

## ğŸš€ å¸¸ç”¨åœºæ™¯

### åœºæ™¯ 1: æ¸…ç†æ—¥å¿—æ•°æ®

```sql
-- æŒ‰æœˆæ¸…ç†æ—§æ—¥å¿—ï¼ˆæ¨èï¼‰
ALTER TABLE logs
DROP PARTITION '2023-06';

-- æˆ–ä½¿ç”¨ TTL è‡ªåŠ¨æ¸…ç†
ALTER TABLE logs
MODIFY TTL event_time + INTERVAL 30 DAY;
```

### åœºæ™¯ 2: åˆ é™¤ç”¨æˆ·æ•°æ®ï¼ˆGDPRï¼‰

```sql
-- åˆ é™¤ç‰¹å®šç”¨æˆ·çš„æ‰€æœ‰æ•°æ®
ALTER TABLE user_events
DELETE WHERE user_id = 'user123';

-- ä½¿ç”¨è½»é‡çº§åˆ é™¤ï¼ˆæ›´é«˜æ•ˆï¼‰
ALTER TABLE user_events
DELETE WHERE user_id = 'user123'
SETTINGS lightweight_delete = 1;
```

### åœºæ™¯ 3: åˆ é™¤æµ‹è¯•æ•°æ®

```sql
-- åˆ é™¤æµ‹è¯•ç¯å¢ƒæ•°æ®
ALTER TABLE events
DELETE WHERE environment = 'test';
```

### åœºæ™¯ 4: æ•°æ®å½’æ¡£

```sql
-- å…ˆå¯¼å‡ºæ•°æ®åˆ°å½’æ¡£è¡¨
INSERT INTO events_archive
SELECT * FROM events
WHERE event_time < '2023-01-01';

-- å†åˆ é™¤åŸè¡¨æ•°æ®
ALTER TABLE events
DROP PARTITION '2022-12';
```

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

1. **å¤‡ä»½ä¼˜å…ˆ**ï¼šæ‰§è¡Œåˆ é™¤æ“ä½œå‰åŠ¡å¿…å¤‡ä»½æ•°æ®
2. **æµ‹è¯•å…ˆè¡Œ**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒæ“ä½œå‰å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
3. **ç›‘æ§èµ„æº**ï¼šåˆ é™¤æ“ä½œä¼šæ¶ˆè€—å¤§é‡ I/O å’Œ CPUï¼Œéœ€è¦ç›‘æ§
4. **æ—¶é—´çª—å£**ï¼šåœ¨ä½å³°æœŸæ‰§è¡Œåˆ é™¤æ“ä½œ
5. **å¼‚æ­¥æ‰§è¡Œ**ï¼šMutation æ˜¯å¼‚æ­¥æ“ä½œï¼Œéœ€è¦ç­‰å¾…å®Œæˆ

## ğŸ’¡ æœ€ä½³å®è·µ

1. **ä¼˜å…ˆä½¿ç”¨åˆ†åŒºåˆ é™¤**ï¼šè¿™æ˜¯æœ€å¿«ã€æœ€å®‰å…¨çš„åˆ é™¤æ–¹å¼
2. **åˆç†è®¾ç½® TTL**ï¼šé¿å…æ‰‹åŠ¨åˆ é™¤çš„ç¹ç
3. **æ‰¹é‡åˆ é™¤**ï¼šå°†å¤§é‡åˆ é™¤æ“ä½œæ‹†åˆ†ä¸ºå¤šä¸ªå°æ‰¹æ¬¡
4. **å®šæœŸç»´æŠ¤**ï¼šå®šæœŸæ¸…ç†éæ´»åŠ¨æ•°æ®å—
5. **ç›‘æ§åˆ é™¤è¿›åº¦**ï¼šä½¿ç”¨ `system.mutations` ç›‘æ§åˆ é™¤è¿›åº¦

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [00-infra/DATA_DEDUP_GUIDE.md](../00-infra/DATA_DEDUP_GUIDE.md) - æ•°æ®å»é‡æŒ‡å—
- [06-admin/BACKUP_RECOVERY_GUIDE.md](../06-admin/BACKUP_RECOVERY_GUIDE.md) - å¤‡ä»½æ¢å¤æŒ‡å—
- [08-information-schema/03_partitions_parts.md](../08-information-schema/03_partitions_parts.md) - åˆ†åŒºå’Œæ•°æ®å—
