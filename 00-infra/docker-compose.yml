networks:
  clickhouse_net:
    driver: bridge

volumes:
  keeper1_data:
  keeper2_data:
  keeper3_data:
  clickhouse1_data:
  clickhouse2_data:

services:
  # ClickHouse Keeper ensemble (3 nodes for quorum)
  keeper1:
    image: zlsmshoqvwt6q1.xuanyuan.run/clickhouse/clickhouse-keeper:latest
    container_name: clickhouse-keeper-1
    hostname: keeper1
    networks:
      - clickhouse_net
    volumes:
      - keeper1_data:/var/lib/clickhouse
      - ./config/keeper1.xml:/etc/clickhouse-server/config.d/keeper.xml
    entrypoint: []
    command: ["/usr/bin/clickhouse-keeper", "--config", "/etc/clickhouse-server/config.d/keeper.xml"]
    restart: unless-stopped

  keeper2:
    image: zlsmshoqvwt6q1.xuanyuan.run/clickhouse/clickhouse-keeper:latest
    container_name: clickhouse-keeper-2
    hostname: keeper2
    networks:
      - clickhouse_net
    volumes:
      - keeper2_data:/var/lib/clickhouse
      - ./config/keeper2.xml:/etc/clickhouse-server/config.d/keeper.xml
    entrypoint: []
    command: ["/usr/bin/clickhouse-keeper", "--config", "/etc/clickhouse-server/config.d/keeper.xml"]
    restart: unless-stopped

  keeper3:
    image: zlsmshoqvwt6q1.xuanyuan.run/clickhouse/clickhouse-keeper:latest
    container_name: clickhouse-keeper-3
    hostname: keeper3
    networks:
      - clickhouse_net
    volumes:
      - keeper3_data:/var/lib/clickhouse
      - ./config/keeper3.xml:/etc/clickhouse-server/config.d/keeper.xml
    entrypoint: []
    command: ["/usr/bin/clickhouse-keeper", "--config", "/etc/clickhouse-server/config.d/keeper.xml"]
    restart: unless-stopped

  # ClickHouse server instances (2 replicas)
  clickhouse1:
    image: zlsmshoqvwt6q1.xuanyuan.run/clickhouse/clickhouse-server:latest
    container_name: clickhouse-server-1
    hostname: clickhouse1
    networks:
      - clickhouse_net
    volumes:
      - clickhouse1_data:/var/lib/clickhouse
      - ./config/clickhouse1.xml:/etc/clickhouse-server/config.d/cluster.xml
      - ./config/users.xml:/etc/clickhouse-server/users.d/users.xml
      - ../test_all_topics.sql:/var/lib/clickhouse/user_files/test_all_topics.sql:ro
    depends_on:
      - keeper1
      - keeper2
      - keeper3
    ports:
      - "8123:8123"  # HTTP API
      - "9000:9000"  # Native TCP protocol
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "clickhouse-client", "--query", "SELECT 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  clickhouse2:
    image: zlsmshoqvwt6q1.xuanyuan.run/clickhouse/clickhouse-server:latest
    container_name: clickhouse-server-2
    hostname: clickhouse2
    networks:
      - clickhouse_net
    volumes:
      - clickhouse2_data:/var/lib/clickhouse
      - ./config/clickhouse2.xml:/etc/clickhouse-server/config.d/cluster.xml
      - ./config/users.xml:/etc/clickhouse-server/users.d/users.xml
      - ../test_all_topics.sql:/var/lib/clickhouse/user_files/test_all_topics.sql:ro
    depends_on:
      - keeper1
      - keeper2
      - keeper3
    ports:
      - "8124:8123"  # HTTP API (different host port)
      - "9001:9000"  # Native TCP protocol (different host port)
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "clickhouse-client", "--query", "SELECT 1"]
      interval: 30s
      timeout: 10s
      retries: 3
